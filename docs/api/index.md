# API Документация

## Общий обзор

API системы управления складом предоставляет RESTful интерфейс для работы со всеми модулями системы. API использует стандартные HTTP методы (GET, POST, PUT, PATCH, DELETE) и возвращает данные в формате JSON.

## Базовые пути

Все API эндпоинты имеют базовый путь `/api`, за которым следует название модуля:

- `/api/auth` - модуль аутентификации и управления пользователями
- `/api/arts` - модуль управления артикулами
- `/api/asks` - модуль управления заявками
- `/api/blocks` - модуль управления блоками
- `/api/segs` - модуль управления сегментами
- `/api/zones` - модуль управления зонами
- `/api/rows` - модуль управления рядами
- `/api/pallets` - модуль управления паллетами
- `/api/poses` - модуль управления позициями
- `/api/defs` - модуль расчета дефицитов
- `/api/dels` - модуль поставок

## Аутентификация

Все защищенные эндпоинты требуют аутентификации через JWT токен. Токен передается в заголовке `Authorization` в формате:

```
Authorization: Bearer <token>
```

Токен получается при успешном входе через эндпоинт `/api/auth/login` и содержит информацию о пользователе и его роли.

## Роли и права доступа

Система использует три уровня ролей:

- **USER** - базовый уровень доступа. Позволяет просматривать данные и создавать заявки.
- **ADMIN** - расширенный уровень доступа. Позволяет просматривать список пользователей, создавать, обновлять и удалять данные в большинстве модулей.
- **PRIME** - максимальный уровень доступа. Создание и полное редактирование пользователей (включая логин), критические операции (удаление рядов, паллет и т.д.).

Каждый эндпоинт имеет указание о требуемой роли в документации модуля.

## Стандартные форматы запросов и ответов

### Формат запроса

Запросы с телом (POST, PUT, PATCH) должны иметь заголовок `Content-Type: application/json` и тело в формате JSON.

### Формат успешного ответа

Успешные ответы возвращают статус код 200 (или 201 для создания) и данные в формате JSON:

```json
{
  "message": "Описание операции",
  "data": {
    /* данные */
  }
}
```

Или для списков:

```json
{
  "exists": true,
  "message": "Описание операции",
  "data": [
    /* массив данных */
  ]
}
```

### Формат ошибки

Ошибки возвращают соответствующий HTTP статус код и описание ошибки:

```json
{
  "message": "Описание ошибки",
  "errors": [
    /* массив ошибок валидации (опционально) */
  ]
}
```

## Коды ошибок

- **400 Bad Request** - ошибка валидации входных данных или некорректный запрос
- **401 Unauthorized** - отсутствует или неверный токен аутентификации
- **403 Forbidden** - недостаточно прав для выполнения операции
- **404 Not Found** - запрашиваемый ресурс не найден
- **409 Conflict** - конфликт данных (например, дублирование уникального значения)
- **500 Internal Server Error** - внутренняя ошибка сервера

## Валидация данных

Все входные данные валидируются с использованием библиотеки Zod. При ошибке валидации возвращается статус 400 с массивом ошибок:

```json
{
  "message": "Validation error",
  "errors": [
    {
      "path": ["fieldName"],
      "message": "Описание ошибки"
    }
  ]
}
```

## Идентификаторы

Все идентификаторы в системе используют формат MongoDB ObjectId (24-символьная шестнадцатеричная строка). Идентификаторы передаются в path параметрах или в теле запроса.

## Пагинация

Эндпоинты, возвращающие списки данных, поддерживают пагинацию через query параметры:

- `page` - номер страницы (начинается с 1)
- `limit` - количество элементов на странице

Ответ содержит информацию о пагинации:

```json
{
  "data": [
    /* данные */
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 100,
    "totalPages": 10,
    "hasNext": true,
    "hasPrev": false
  }
}
```

## Поиск

Многие эндпоинты поддерживают поиск через query параметр `search`. Поиск выполняется по текстовым полям (названия, артикулы и т.д.).

## Сортировка

Эндпоинты, возвращающие списки данных, могут поддерживать сортировку через query параметры:

- `sortBy` - поле для сортировки
- `sortOrder` - направление сортировки ("asc" или "desc")

## Транзакции

Критичные операции выполняются в рамках MongoDB транзакций для обеспечения целостности данных. Это гарантирует что либо все изменения применяются, либо ни одно не применяется.

## Кэширование данных

Многие модули кэшируют связанные данные (например, данные пользователя в заявках, данные паллеты в позициях) для повышения производительности. Кэшированные данные обновляются при изменении связанных сущностей.

## Документация модулей

Детальная документация по эндпоинтам каждого модуля находится в соответствующих файлах:

- [Модуль Auth](../modules/auth.md)
- [API админки пользователей (для фронтенда)](auth/admin-users.md)
- [Модуль Arts](../modules/arts.md)
- [Модуль Asks](../modules/asks.md)
- [Модуль Blocks](../modules/blocks.md)
- [Модуль Segs](../modules/segs.md)
- [Модуль Zones](../modules/zones.md)
- [Модуль Rows](../modules/rows.md)
- [Модуль Pallets](../modules/pallets.md)
- [Модуль Poses](../modules/poses.md)
- [Модуль Defs](../modules/defs.md)
- [Модуль Dels](../modules/dels.md)
- [Модуль Comps](../modules/comps.md)
- [Модуль Pallet-groups](../modules/palgrs.md)
- [API поставок (для фронтенда)](dels.md)
