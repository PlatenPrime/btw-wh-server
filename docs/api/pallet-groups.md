## Модуль Pallet-groups — спецификация API для фронтенда

### Общий обзор

API модуля `pallet-groups` предоставляет фронтенду управляемый слой логической группировки паллет. Через эти эндпоинты фронт может:

- получать список групп паллет с порядком отображения;
- получать конкретную группу вместе с краткой информацией по её паллетам;
- создавать и переименовывать группы, менять их порядок;
- управлять составом паллет в группах;
- инициировать массовые операции по сбросу и пересчёту секторов паллет.

Все эндпоинты расположены по базовому пути `/api/pallet-groups` и используют стандартные форматы запросов и ответов, описанные в общей API-документации.

**Отдельные описания:** [GET free-pallets](pallet-groups/get-free-pallets.md) — компактная спецификация эндпоинта свободных паллет для фронтенда.

### Список эндпоинтов

#### Получение списка групп

**GET `/api/pallet-groups`**  
Возвращает упорядоченный список всех групп паллет.

- **Назначение для фронта**:  
  использовать для построения общего списка групп (например, колонок или блоков) без загрузки детальной информации о паллетах.
- **Ответ** содержит массив объектов, где для каждой группы фронту гарантируется:
  - строковый идентификатор группы;
  - строковое название группы;
  - числовой порядок группы (целое число, начиная с 1).
- **Особенности**:
  - порядок элементов в массиве соответствует сортировке по полю порядка по возрастанию;
  - этот порядок следует воспринимать как каноничный при отрисовке интерфейса.

#### Получение группы по идентификатору

**GET `/api/pallet-groups/:id`**  
Возвращает одну группу паллет по её идентификатору вместе с краткими данными по входящим в неё паллетам.

- **Назначение для фронта**:  
  использовать для детальной отрисовки одной группы, включая список паллет, их сектора и признаки, важные для интерфейса.
- **Ответ** содержит объект группы с полями:
  - строковый идентификатор группы;
  - уникальное строковое название группы;
  - числовой порядок;
  - массив паллет в том порядке, который используется для отображения.
- **Ошибки**:
  - при неверном формате идентификатора возвращается ошибка с кодом 400;
  - при отсутствии группы — ошибка с кодом 404.

#### Получение свободных паллет

**GET `/api/pallet-groups/free-pallets`**  
Возвращает список паллет, не привязанных ни к одной паллетной группе — паллеты, доступные для добавления в группы.

- **Назначение для фронта**:  
  использовать при выборе паллет для добавления в группу (например, перед вызовом `set-pallets`), чтобы отображать только кандидатов, ещё не входящих ни в одну группу.
- **Ответ** содержит объект с полями:
  - `message` — строка об успешном выполнении;
  - `data` — массив объектов в формате краткого DTO паллеты (`id`, `title`, `sector`, `isDef`, `isEmpty`), отсортированный по названию паллеты.
- Формат элемента в `data` совпадает с «Краткое DTO паллеты внутри группы» (см. раздел структур данных ниже).

#### Создание группы

**POST `/api/pallet-groups`**  
Создаёт новую группу паллет.

- **Назначение для фронта**:  
  использовать при создании новой логической группы (например, новой колонки) без немедленного наполнения её паллетами.
- **Тело запроса** ожидает:
  - строковое название группы (обязательно);
  - числовой порядок группы (обязательно, целое положительное число).
- **Ответ**:
  - содержит объект новой группы с идентификатором, названием, порядком;
  - массив паллет в ответе для только что созданной группы является пустым.
- **Инварианты**:
  - название группы должно быть уникальным; при попытке создать группу с уже существующим названием возвращается ошибка конфликта с кодом 409;
  - порядок не может быть нулём или отрицательным числом.

#### Обновление группы

**PUT `/api/pallet-groups/:id`**  
Обновляет существующую группу (название, порядок или оба поля).

- **Назначение для фронта**:  
  использовать для сценариев переименования группы и изменения её относительного положения среди других групп (например, при изменении порядка колонок).
- **Тело запроса** может содержать:
  - новое название группы (опционально);
  - новое значение порядка (опционально).
- **Ответ**:
  - возвращает актуальное состояние группы с её идентификатором, названием, порядком и массивом идентификаторов паллет, которые к ней относятся;
  - порядок паллет в массиве соответствует их текущему положению внутри группы.
- **Инварианты**:
  - при смене названия по-прежнему сохраняется требование уникальности;
  - фронт не должен пытаться выставлять порядок таким образом, чтобы полагаться на плотность значений (допустимы «дыры» и большие шаги).

#### Удаление группы

**DELETE `/api/pallet-groups/:id`**  
Удаляет группу паллет по идентификатору.

- **Назначение для фронта**:  
  использовать для административных сценариев, когда некоторая логическая группа больше не нужна.
- **Поведение**:
  - группа перестаёт существовать и не будет участвовать в последующих пересчётах секторов;
  - сами паллеты остаются в системе и могут быть добавлены в другие группы или оставаться без группы.

#### Установка состава паллет для группы

**POST `/api/pallet-groups/set-pallets`**  
Задаёт точный список паллет, которые относятся к указанной группе.

- **Назначение для фронта**:  
  использовать при сценариях drag-and-drop, когда пользователь меняет состав группы (например, перетаскивает паллеты между колонками или внутри одной колонки).
- **Тело запроса** ожидает:
  - идентификатор группы;
  - массив идентификаторов паллет в том порядке, в котором они должны отображаться.
- **Ответ**:
  - возвращает объект группы с идентификатором, названием, порядком и массивом паллет, где для каждой паллеты предоставляется краткое представление, пригодное для отрисовки.
- **Инварианты**:
  - одна паллета не должна одновременно принадлежать нескольким группам;
  - фронт обязан передавать полный итоговый список паллет группы, а не только изменения, чтобы сохранить консистентность порядка.

#### Отвязка паллеты от группы

**POST `/api/pallet-groups/unlink-pallet`**  
Убирает одну паллету из той группы, к которой она сейчас привязана.

- **Назначение для фронта**:  
  использовать при удалении паллеты из группы без немедленного добавления её в другую группу (например, «вытащить» паллету в состояние «без группы»).
- **Входные данные**:
  - идентификатор паллеты (может передаваться в теле запроса или как параметр маршрута, в зависимости от используемой конфигурации).
- **Ответ**:
  - при успешной операции возвращает обновлённое состояние группы, из которой паллета была удалена, с кратким списком её паллет;
  - если паллета не привязана ни к одной группе, возвращается ошибка с кодом 404 и сообщением о том, что связь отсутствует.

#### Сброс секторов паллет

**POST `/api/pallet-groups/reset-pallets-sectors`**  
Массово сбрасывает секторы всех паллет и очищает их связь с группами.

- **Назначение для фронта**:  
  используется редко, в административных сценариях, когда требуется полностью обнулить текущее разбиение по группам и секторам перед построением новой структуры.
- **Ответ**:
  - возвращает агрегированные числа по количеству затронутых паллет (сколько было найдено и сколько действительно изменено).

#### Пересчёт секторов паллет

**POST `/api/pallet-groups/recalculate-pallets-sectors`**  
Пересчитывает сектора паллет на основе текущих групп и порядка паллет в них.

- **Назначение для фронта**:  
  использовать после серии операций по изменению порядка групп и состава паллет, когда необходимо привести сектора в согласованное состояние, на которое ориентируются другие части системы.
- **Поведение**:
  - для паллет, входящих в группы, пересчитываются сектора и обновляется кэшированная связь с группой;
  - для паллет вне групп выставляется нулевой сектор и очищается ссылка на группу.
- **Ответ**:
  - содержит количество паллет, для которых были обновлены данные;
  - содержит количество групп, участвовавших в расчёте.

### Структуры данных (DTO) для фронтенда

#### DTO группы паллет

Для фронтенда группа паллет представляется объектом со следующими стабильными полями:

- `id` — строковый идентификатор группы;
- `title` — уникальное строковое название группы, показываемое пользователю;
- `order` — целое число, определяющее относительный порядок группы;

Особенности и инварианты:

- фронт может считать поля `id`, `title` и `order` обязательными и стабильными во всех ответах, где возвращается группа;
- порядок групп при получении списка отражает сортировку по `order` по возрастанию — этот порядок можно использовать напрямую при отображении.

#### Краткое DTO паллеты внутри группы

При работе с группами паллеты возвращаются в кратком виде, достаточном для отрисовки и навигации. Для фронта важны следующие характеристики этого представления:

- каждая паллета имеет строковый идентификатор;
- у паллеты есть читаемое название;
- у паллеты есть числовой сектор, отражающий её положение в логической сетке;
- у паллеты есть признак дефицитности;
- паллета может содержать данные о количестве позиций или сами идентификаторы позиций, если это требуется для интерфейса.

Особенности и инварианты:

- фронт может полагаться на наличие идентификатора, названия, сектора и признака дефицитности во всех кратких представлениях паллет, возвращаемых вместе с группами;
- порядок паллет в массиве группы отражает их цельный порядок отображения внутри этой группы и должен сохраняться при отрисовке.

### Инварианты и ожидания для фронта

- **Уникальность названий групп**:  
  фронт не должен создавать несколько групп с одинаковым названием. При попытке это сделать бэкенд вернёт ошибку конфликта.

- **Единственность принадлежности паллеты группе**:  
  одна и та же паллета не должна одновременно находиться в нескольких группах. Фронт должен следить за тем, чтобы паллета при переносе из одной группы в другую удалялась из исходной группы.

- **Порядок групп и паллет**:  
  порядок групп определяется полем `order`, порядок паллет внутри группы — позицией в массиве. Эти два уровня порядка используются для расчёта секторов и должны рассматриваться как основа для визуального расположения.

- **Безопасное изменение порядка и состава**:  
  при drag-and-drop сценариях фронт должен:
  - формировать полный итоговый список паллет для каждой изменённой группы и отправлять его через эндпоинт установки состава;
  - при необходимости вызывать пересчёт секторов, чтобы данные для других модулей и интерфейсов стали согласованными.

- **Работа с паллетами без группы**:  
  паллеты, не входящие ни в одну группу, имеют нулевой сектор и не содержат кэшированной связи с группой. Фронт может использовать это как явный признак того, что паллета находится вне любой логической группы и может быть добавлена в подходящую группу или оставлена в отдельном списке.

---

### Примеры использования API

Во всех примерах ниже предполагается, что запросы отправляются с заголовком `Authorization: Bearer <token>`. Базовый путь — `/api/pallet-groups`. Идентификаторы — валидные MongoDB ObjectId (24 шестнадцатеричных символа).

#### GET `/api/pallet-groups` — список всех групп

**Запрос:**

```http
GET /api/pallet-groups HTTP/1.1
Host: example.com
Authorization: Bearer <token>
```

**Ответ 200:**

```json
{
  "message": "Pallet groups fetched successfully",
  "data": [
    {
      "id": "507f1f77bcf86cd799439011",
      "title": "Горячие паллеты",
      "order": 1
    },
    {
      "id": "507f1f77bcf86cd799439012",
      "title": "Дальний склад",
      "order": 2
    }
  ]
}
```

#### GET `/api/pallet-groups/:id` — группа с паллетами

**Запрос:**

```http
GET /api/pallet-groups/507f1f77bcf86cd799439011 HTTP/1.1
Host: example.com
Authorization: Bearer <token>
```

**Ответ 200:**

```json
{
  "message": "Pallet group fetched successfully",
  "data": {
    "id": "507f1f77bcf86cd799439011",
    "title": "Горячие паллеты",
    "order": 1,
    "pallets": [
      {
        "id": "507f1f77bcf86cd799439021",
        "title": "Паллета-A1",
        "sector": 101,
        "isDef": false,
        "isEmpty": false
      },
      {
        "id": "507f1f77bcf86cd799439022",
        "title": "Паллета-A2",
        "sector": 102,
        "isDef": true,
        "isEmpty": false
      }
    ]
  }
}
```

**Ответ 400 (неверный id):**

```json
{
  "message": "Invalid pallet group id"
}
```

**Ответ 404:**

```json
{
  "message": "Pallet group not found"
}
```

#### GET `/api/pallet-groups/free-pallets` — свободные паллеты

**Запрос:**

```http
GET /api/pallet-groups/free-pallets HTTP/1.1
Host: example.com
Authorization: Bearer <token>
```

**Ответ 200 (есть свободные паллеты):**

```json
{
  "message": "Free pallets fetched successfully",
  "data": [
    {
      "id": "507f1f77bcf86cd799439023",
      "title": "Паллета-B1",
      "sector": 0,
      "isDef": false,
      "isEmpty": true
    }
  ]
}
```

**Ответ 200 (нет свободных паллет):**

```json
{
  "message": "Free pallets fetched successfully",
  "data": []
}
```

#### POST `/api/pallet-groups` — создание группы

**Запрос:**

```http
POST /api/pallet-groups HTTP/1.1
Host: example.com
Authorization: Bearer <token>
Content-Type: application/json

{
  "title": "Новая колонка",
  "order": 3
}
```

Поле `order` опционально; при отсутствии бэкенд может назначить порядок сам.

**Ответ 201:**

```json
{
  "message": "Pallet group created successfully",
  "data": {
    "id": "507f1f77bcf86cd799439013",
    "title": "Новая колонка",
    "order": 3,
    "pallets": []
  }
}
```

**Ответ 409 (дубликат названия):**

```json
{
  "message": "Pallet group with this title already exists"
}
```

**Ответ 400 (валидация):**

```json
{
  "message": "Invalid data",
  "errors": [
    {
      "code": "too_small",
      "minimum": 1,
      "path": ["title"],
      "message": "Title is required"
    }
  ]
}
```

#### PUT `/api/pallet-groups/:id` — обновление группы

**Запрос (переименование и смена порядка):**

```http
PUT /api/pallet-groups/507f1f77bcf86cd799439011 HTTP/1.1
Host: example.com
Authorization: Bearer <token>
Content-Type: application/json

{
  "title": "Горячие паллеты (приоритет)",
  "order": 1
}
```

Можно передать только `title`, только `order` или оба поля.

**Ответ 200:**

```json
{
  "message": "Pallet group updated successfully",
  "data": {
    "id": "507f1f77bcf86cd799439011",
    "title": "Горячие паллеты (приоритет)",
    "order": 1,
    "pallets": ["507f1f77bcf86cd799439021", "507f1f77bcf86cd799439022"]
  }
}
```

#### DELETE `/api/pallet-groups/:id` — удаление группы

**Запрос:**

```http
DELETE /api/pallet-groups/507f1f77bcf86cd799439012 HTTP/1.1
Host: example.com
Authorization: Bearer <token>
```

**Ответ 200:**

```json
{
  "message": "Pallet group deleted successfully"
}
```

**Ответ 404:**

```json
{
  "message": "Pallet group not found"
}
```

#### POST `/api/pallet-groups/set-pallets` — установка состава паллет

**Запрос (полный список паллет группы в нужном порядке):**

```http
POST /api/pallet-groups/set-pallets HTTP/1.1
Host: example.com
Authorization: Bearer <token>
Content-Type: application/json

{
  "groupId": "507f1f77bcf86cd799439011",
  "palletIds": [
    "507f1f77bcf86cd799439021",
    "507f1f77bcf86cd799439023",
    "507f1f77bcf86cd799439022"
  ]
}
```

Массив `palletIds` не должен содержать дубликатов; минимум один элемент обязателен.

**Ответ 200:**

```json
{
  "message": "Pallets set for group successfully",
  "data": {
    "id": "507f1f77bcf86cd799439011",
    "title": "Горячие паллеты",
    "order": 1,
    "pallets": [
      {
        "id": "507f1f77bcf86cd799439021",
        "title": "Паллета-A1",
        "sector": 101,
        "isDef": false,
        "isEmpty": false
      },
      {
        "id": "507f1f77bcf86cd799439023",
        "title": "Паллета-A3",
        "sector": 102,
        "isDef": false,
        "isEmpty": true
      },
      {
        "id": "507f1f77bcf86cd799439022",
        "title": "Паллета-A2",
        "sector": 103,
        "isDef": true,
        "isEmpty": false
      }
    ]
  }
}
```

После изменения состава групп для актуализации секторов паллет нужно вызвать пересчёт (см. ниже).

#### POST `/api/pallet-groups/unlink-pallet` — отвязка паллеты от группы

**Запрос (идентификатор паллеты в теле):**

```http
POST /api/pallet-groups/unlink-pallet HTTP/1.1
Host: example.com
Authorization: Bearer <token>
Content-Type: application/json

{
  "palletId": "507f1f77bcf86cd799439022"
}
```

**Ответ 200:**

```json
{
  "message": "Pallet unlinked from group successfully",
  "data": {
    "id": "507f1f77bcf86cd799439011",
    "title": "Горячие паллеты",
    "order": 1,
    "pallets": [
      {
        "id": "507f1f77bcf86cd799439021",
        "title": "Паллета-A1",
        "sector": 101,
        "isDef": false,
        "isEmpty": false
      }
    ]
  }
}
```

Возвращается обновлённая группа, из которой паллета была удалена.

**Ответ 404 (паллета не в группе):**

```json
{
  "message": "Pallet is not linked to any group"
}
```

#### POST `/api/pallet-groups/reset-pallets-sectors` — сброс секторов

**Запрос:**

```http
POST /api/pallet-groups/reset-pallets-sectors HTTP/1.1
Host: example.com
Authorization: Bearer <token>
```

Тело запроса не требуется.

**Ответ 200:**

```json
{
  "message": "Pallets sectors reset successfully",
  "data": {
    "matchedCount": 150,
    "modifiedCount": 120
  }
}
```

#### POST `/api/pallet-groups/recalculate-pallets-sectors` — пересчёт секторов

**Запрос:**

```http
POST /api/pallet-groups/recalculate-pallets-sectors HTTP/1.1
Host: example.com
Authorization: Bearer <token>
```

Тело запроса не требуется.

**Ответ 200:**

```json
{
  "message": "Pallets sectors recalculated successfully",
  "data": {
    "updatedPallets": 45,
    "groupsProcessed": 3
  }
}
```

Типичный сценарий для фронта: после нескольких вызовов `set-pallets` и/или `PUT` группы вызвать один раз `recalculate-pallets-sectors`, чтобы сектора паллет и кэш группы в паллетах соответствовали текущему составу и порядку групп.
