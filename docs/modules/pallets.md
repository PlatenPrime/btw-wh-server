# Модуль Pallets

## Описание модуля

Модуль `pallets` решает задачи управления паллетами склада. Паллеты являются промежуточным уровнем между рядами и позициями, позволяя группировать позиции товаров в логические единицы. Модуль обеспечивает создание и управление паллетами, их привязку к рядам, перемещение позиций между паллетами, а также работу с дефицитными паллетами. Модуль является основой для организации позиций товаров на складе.

## Сущности модуля

### Pallet (Паллета)

Паллета представляет собой логическую группу позиций товаров внутри ряда. Это реальная организационная единица склада, которая объединяет несколько позиций для удобства управления. Паллета имеет уникальное название, принадлежит одному ряду, содержит массив позиций, может быть помечена как дефицитная, и имеет опциональный сектор для организации пространства.

## Связи между сущностями

- **Pallet → Row**: Многие к одному. Каждая паллета принадлежит одному ряду. Связь осуществляется через поле row (ObjectId) и кэшированные данные ряда в поле rowData.

- **Pallet → Pos**: Один ко многим. Каждая паллета может содержать множество позиций. Связь осуществляется через массив ObjectId в поле poses паллеты. Позиции являются отдельной коллекцией, а не вложенными документами.

## Концепции и принятые решения

### Промежуточный уровень между рядами и позициями

Паллеты служат промежуточным уровнем между рядами и позициями. Это позволяет группировать позиции в логические единицы и обеспечивает гибкость в организации пространства склада. Без паллет пришлось бы напрямую связывать позиции с рядами, что усложнило бы структуру.

### Кэширование данных ряда

Данные ряда (rowData) кэшируются в паллете. Это позволяет избежать дополнительных запросов к базе данных при работе с паллетами и обеспечивает целостность данных даже если ряд изменится после создания паллеты.

### Дефицитные паллеты

Паллета может быть помечена как дефицитная (isDef = true). Это используется для отслеживания паллет с товарами, которые находятся в дефиците, и позволяет быстро находить такие паллеты для пополнения или перемещения.

### Секторы

Паллета может иметь сектор для организации пространства. Сектор используется для упрощения навигации по складу и может быть связан с секторами зон из модуля zones.

### Перемещение позиций

Модуль поддерживает перемещение всех позиций с одной паллеты на другую. При этом целевая паллета должна быть пустой, а исходная паллета должна содержать позиции. Операция выполняется в рамках транзакции для обеспечения целостности данных.

### Удаление позиций

Модуль поддерживает удаление всех позиций паллеты или только пустых позиций (с количеством 0). Это позволяет очищать паллеты от неактуальных данных.

### Транзакции

Операции создания, обновления и перемещения паллет выполняются в рамках MongoDB транзакций. Это гарантирует целостность данных между рядами, паллетами и позициями.

## API эндпоинты

### GET `/api/pallets`

Получение всех паллет.

**Запрос:**
- Query параметры отсутствуют

**Ответ:**
- 200: `Array<Pallet>`
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль USER

### GET `/api/pallets/empty`

Получение всех пустых паллет (без позиций).

**Запрос:**
- Query параметры отсутствуют

**Ответ:**
- 200: `Array<Pallet>`
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль USER

### GET `/api/pallets/by-row/:rowId`

Получение всех паллет ряда.

**Запрос:**
- Path параметры: `rowId` (MongoDB ObjectId)

**Ответ:**
- 200: `Array<Pallet>`
- 400: `{ message: string, errors?: array }` - неверный формат ID
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль USER

### GET `/api/pallets/by-title/:title`

Получение паллеты по названию.

**Запрос:**
- Path параметры: `title` (string)

**Ответ:**
- 200: `Pallet`
- 400: `{ message: string, errors?: array }` - название не указано
- 404: `{ message: string }` - паллета не найдена
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль USER

### GET `/api/pallets/:id`

Получение паллеты по идентификатору.

**Запрос:**
- Path параметры: `id` (MongoDB ObjectId)

**Ответ:**
- 200: `Pallet`
- 400: `{ message: string, errors?: array }` - неверный формат ID
- 404: `{ message: string }` - паллета не найдена
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль USER

### POST `/api/pallets`

Создание новой паллеты.

**Запрос:**
- Body: `{ title: string, rowData: { _id: string, title: string }, sector?: string, isDef?: boolean }`

**Ответ:**
- 201: `Pallet`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 404: `{ message: string }` - ряд не найден
- 409: `{ message: string }` - паллета с таким названием уже существует
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### POST `/api/pallets/move-poses`

Перемещение всех позиций с одной паллеты на другую.

**Запрос:**
- Body: `{ sourcePalletId: string, targetPalletId: string }`

**Ответ:**
- 200: `{ message: string, targetPallet: Pallet }`
- 400: `{ message: string, errors?: array }` - ошибка валидации или целевая паллета не пуста, или исходная паллета пуста
- 404: `{ message: string }` - паллета или ряд не найдены
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### PUT `/api/pallets/:id`

Обновление паллеты.

**Запрос:**
- Path параметры: `id` (MongoDB ObjectId)
- Body: `{ title?: string, rowData?: { _id: string, title: string }, sector?: string, isDef?: boolean }` (все поля опциональны)

**Ответ:**
- 200: `Pallet`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 404: `{ message: string }` - паллета или ряд не найдены
- 409: `{ message: string }` - паллета с таким названием уже существует
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### DELETE `/api/pallets/:id`

Удаление паллеты.

**Запрос:**
- Path параметры: `id` (MongoDB ObjectId)

**Ответ:**
- 200: `Pallet`
- 400: `{ message: string, errors?: array }` - неверный формат ID
- 404: `{ message: string }` - паллета не найдена
- 500: `{ message: string, error?: any }` - ошибка сервера

**Примечание:** При удалении паллеты все связанные позиции теряют связь с паллетой (поля pallet, palletData обновляются).

**Доступ:** Требует роль PRIME

### DELETE `/api/pallets/:id/poses`

Удаление всех позиций паллеты.

**Запрос:**
- Path параметры: `id` (MongoDB ObjectId)

**Ответ:**
- 200: `{ message: string, deletedCount: number }`
- 400: `{ message: string, errors?: array }` - неверный формат ID
- 404: `{ message: string }` - паллета не найдена
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### DELETE `/api/pallets/:id/empty-poses`

Удаление всех пустых позиций паллеты (с количеством 0).

**Запрос:**
- Path параметры: `id` (MongoDB ObjectId)

**Ответ:**
- 200: `{ message: string, deletedCount: number }`
- 400: `{ message: string, errors?: array }` - неверный формат ID
- 404: `{ message: string }` - паллета не найдена
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

## Форматы данных

### Pallet

```typescript
{
  _id: string;                    // MongoDB ObjectId
  title: string;                   // Уникальное название паллеты
  row: string;                    // ObjectId ряда
  rowData: {                       // Кэшированные данные ряда
    _id: string;
    title: string;
  };
  poses: Array<string>;           // Массив ObjectId позиций
  isDef: boolean;                 // Флаг дефицитной паллеты
  sector?: string;                // Сектор паллеты
  createdAt?: Date;                // Дата создания
  updatedAt?: Date;                // Дата обновления
}
```

