# Модуль Blocks

## Описание модуля

Модуль `blocks` решает задачи управления блоками склада. Блоки являются верхним уровнем иерархической структуры организации склада и служат для группировки сегментов, которые в свою очередь содержат зоны. Модуль обеспечивает создание и управление блоками, автоматический расчет их порядка, а также управление секторами зон на основе позиций блоков и сегментов. Модуль является основой для организации пространства склада и позволяет эффективно структурировать зоны хранения.

## Сущности модуля

### Block (Блок)

Блок представляет собой логическую группу сегментов на складе. Это реальная организационная единица склада, которая объединяет несколько сегментов для удобства управления. Блок имеет уникальное название, порядковый номер определяющий его позицию в общей структуре, и массив ссылок на сегменты которые в него входят.

## Связи между сущностями

- **Block → Seg**: Один ко многим. Каждый блок может содержать множество сегментов. Связь осуществляется через массив ObjectId в поле segs блока. Сегменты являются отдельной коллекцией, а не вложенными документами, что позволяет эффективно работать с ними независимо.

- **Block → Zone**: Косвенная связь через сегменты. Блоки связаны со зонами через сегменты: Block → Seg → Zone. Все зоны в сегментах блока получают сектор рассчитанный на основе порядка блока и порядка сегмента.

## Концепции и принятые решения

### Иерархия Block → Seg → Zone

Структура склада организована в виде трехуровневой иерархии: блоки содержат сегменты, сегменты содержат зоны. Это позволяет гибко организовывать пространство склада и эффективно управлять большим количеством зон. Блоки служат для логической группировки, сегменты для физической организации, зоны для конкретных мест хранения.

### Расчет секторов

Сектор зоны рассчитывается по формуле: `sector = blockOrder * 1000 + segOrder`. Множитель 1000 позволяет разделить сектора между блоками, обеспечивая уникальность секторов для каждого сегмента. Порядок блоков и сегментов начинается с 1, а не с 0. Все зоны в одном сегменте получают одинаковый сектор. Зоны без сегмента получают сектор 0.

### Порядок блоков

Каждый блок имеет поле order, которое определяет его позицию в общей структуре. Порядок используется для расчета секторов и должен быть уникальным или последовательным. При создании нового блока порядок автоматически присваивается как следующий после максимального существующего порядка.

### Массовые операции

Модуль поддерживает массовую операцию upsert для синхронизации списка блоков. Это позволяет обновлять всю структуру блоков за один запрос, что критично при работе с большими объемами данных или при импорте из внешних систем.

### Пересчет секторов

Пересчет секторов зон не происходит автоматически при изменении порядка блоков или сегментов. Это сделано для повышения производительности, так как пересчет является ресурсоемкой операцией. Пересчет выполняется явно через специальный эндпоинт после завершения всех изменений структуры.

## API эндпоинты

### POST `/api/blocks`

Создание нового блока.

**Запрос:**
- Body: `{ title: string }`

**Ответ:**
- 201: `{ message: string, data: Block }`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 409: `{ message: string }` - блок с таким названием уже существует
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### GET `/api/blocks`

Получение всех блоков, отсортированных по порядку.

**Запрос:**
- Query параметры отсутствуют

**Ответ:**
- 200: `{ exists: boolean, message: string, data: Array<Block> }`
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### GET `/api/blocks/:id`

Получение блока по идентификатору.

**Запрос:**
- Path параметры: `id` (MongoDB ObjectId)

**Ответ:**
- 200: `{ exists: boolean, message: string, data: Block | null }`
- 400: `{ message: string, errors?: array }` - неверный формат ID
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### PUT `/api/blocks/:id`

Обновление блока.

**Запрос:**
- Path параметры: `id` (MongoDB ObjectId)
- Body: `{ title?: string, order?: number, segs?: Array<string> }` (все поля опциональны)

**Ответ:**
- 200: `{ message: string, data: Block }`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 404: `{ message: string }` - блок не найден или сегменты не найдены
- 409: `{ message: string }` - блок с таким названием уже существует
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

**Примечание:** Сектора зон не пересчитываются автоматически.

### PATCH `/api/blocks/:id/rename`

Переименование блока.

**Запрос:**
- Path параметры: `id` (MongoDB ObjectId)
- Body: `{ title: string }`

**Ответ:**
- 200: `{ message: string, data: Block }`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 404: `{ message: string }` - блок не найден
- 409: `{ message: string }` - блок с таким названием уже существует
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### DELETE `/api/blocks/:id`

Удаление блока.

**Запрос:**
- Path параметры: `id` (MongoDB ObjectId)

**Ответ:**
- 200: `{ message: string, data: Block }`
- 400: `{ message: string, errors?: array }` - неверный формат ID
- 404: `{ message: string }` - блок не найден
- 500: `{ message: string, error?: any }` - ошибка сервера

**Примечание:** При удалении блока все связанные сегменты удаляются, а зоны теряют связь с сегментами (поле seg удаляется, sector = 0).

**Доступ:** Требует роль ADMIN

### POST `/api/blocks/upsert`

Массовое создание или обновление блоков.

**Запрос:**
- Body: `Array<{ _id?: string, title: string, order: number, segs?: Array<string> }>`

**Ответ:**
- 200: `{ message: string, data: { bulkResult: object, updatedBlocks: Array<Block> } }`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### POST `/api/blocks/recalculate-zones-sectors`

Пересчет секторов всех зон на основе текущих позиций блоков и сегментов.

**Запрос:**
- Body отсутствует

**Ответ:**
- 200: `{ message: string, data: { updatedZones: number, updatedSegs: number, blocksProcessed: number } }`
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

**Примечание:** Ресурсоемкая операция, выполняется для всех зон и сегментов.

### POST `/api/blocks/reset-zones-sectors`

Сброс секторов всех зон в 0.

**Запрос:**
- Body отсутствует

**Ответ:**
- 200: `{ message: string, data: { matchedCount: number, modifiedCount: number } }`
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

**Примечание:** Утилитарный эндпоинт для инициализации.

## Форматы данных

### Block

```typescript
{
  _id: string;                    // MongoDB ObjectId
  title: string;                  // Уникальное название блока
  order: number;                  // Порядок блока (начинается с 1)
  segs: Array<string>;            // Массив ObjectId сегментов
  createdAt: Date;                // Дата создания
  updatedAt: Date;                // Дата обновления
}
```

