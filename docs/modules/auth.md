# Модуль Auth

## Описание модуля

Модуль `auth` решает задачи аутентификации и управления пользователями системы. Он обеспечивает безопасный вход в систему, регистрацию новых пользователей, управление их данными и контроль доступа на основе ролей. Модуль является основой системы безопасности приложения, определяя кто может выполнять те или иные действия в системе.

## Сущности модуля

### User (Пользователь)

Пользователь представляет реального человека, который работает с системой. Это может быть складской работник, администратор или менеджер. Пользователь имеет уникальное имя для входа (username), полное имя для отображения, пароль для аутентификации, роль определяющую его права доступа, а также опциональные контактные данные (telegram, фото).

### Role (Роль)

Роль определяет уровень доступа пользователя в системе. Роль представляет собой набор прав, которые определяют какие действия может выполнять пользователь. В системе существует иерархия ролей: USER (базовый уровень), ADMIN (расширенные права), PRIME (максимальные права).

## Связи между сущностями

- **User → Role**: Многие к одному. Каждый пользователь имеет одну роль, которая определяет его права доступа. Роль хранится как ссылка на коллекцию ролей, но также может быть строковым значением для обратной совместимости.

## Концепции и принятые решения

### JWT токены

Для аутентификации используется механизм JWT (JSON Web Tokens). После успешного входа пользователь получает токен, который содержит информацию о его идентификаторе и роли. Этот токен используется для последующих запросов к защищенным эндпоинтам через заголовок Authorization с форматом Bearer Token.

### Хеширование паролей

Пароли пользователей никогда не хранятся в открытом виде. При создании или обновлении пароля используется алгоритм хеширования bcryptjs, который преобразует пароль в необратимое хеш-значение. Это обеспечивает безопасность данных даже в случае компрометации базы данных.

### Кэширование данных пользователя

В некоторых операциях (например, при работе с заявками) данные пользователя кэшируются в виде поддокументов. Это позволяет избежать дополнительных запросов к базе данных и повышает производительность системы.

### Транзакции

Критичные операции, такие как создание и обновление пользователей, выполняются в рамках MongoDB транзакций. Это гарантирует целостность данных и позволяет откатить изменения в случае ошибки.

## API эндпоинты

### POST `/api/auth/login`

Вход в систему.

**Запрос:**
- Body: `{ username: string, password: string }`

**Ответ:**
- 200: `{ user: User (без password), token: string }`
- 400: `{ message: string }` - ошибка валидации или неверные учетные данные

**Доступ:** Публичный (не требует авторизации)

### POST `/api/auth/register`

Регистрация нового пользователя.

**Запрос:**
- Body: `{ username: string, password: string, fullname: string, role?: string, telegram?: string, photo?: string }`

**Ответ:**
- 201: `{ user: User (без password) }`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 409: `{ message: string }` - пользователь с таким username уже существует
- 500: `{ message: string, error: any }` - ошибка сервера

**Доступ:** Публичный (не требует авторизации)

### GET `/api/auth/users`

Получение списка всех пользователей.

**Запрос:**
- Query параметры отсутствуют

**Ответ:**
- 200: `Array<User (без password)>`
- 500: `{ message: string, error: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN (или выше)

### POST `/api/auth/users`

Создание пользователя (админка). Доступно только для PRIME.

**Запрос:**
- Body: `{ username: string, password: string, fullname: string, role?: string, telegram?: string, photo?: string }`

**Ответ:**
- 201: `{ user: User (без password) }`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 409: `{ message: string }` - пользователь с таким username уже существует
- 500: `{ message: string, error: any }` - ошибка сервера

**Доступ:** Требует роль PRIME

### GET `/api/auth/users/:id`

Получение пользователя по идентификатору.

**Запрос:**
- Path параметры: `id` (MongoDB ObjectId)

**Ответ:**
- 200: `{ user: User (без password) }`
- 400: `{ message: string, errors?: array }` - неверный формат ID
- 404: `{ message: string }` - пользователь не найден
- 500: `{ message: string, error: any }` - ошибка сервера

**Доступ:** Требует роль USER (любой авторизованный пользователь)

### GET `/api/auth/me/:id`

Получение информации о текущем пользователе с обновленным токеном.

**Запрос:**
- Path параметры: `id` (MongoDB ObjectId)

**Ответ:**
- 200: `{ user: User (без password), token: string }`
- 400: `{ message: string, errors?: array }` - неверный формат ID
- 404: `{ message: string }` - пользователь не найден
- 500: `{ message: string, error: any }` - ошибка сервера

**Доступ:** Требует роль USER (любой авторизованный пользователь)

### PUT `/api/auth/users/:userId`

Обновление информации о пользователе (все поля, включая username). Доступно только для PRIME.

**Запрос:**
- Path параметры: `userId` (MongoDB ObjectId)
- Body: `{ username?: string, password?: string, fullname?: string, role?: string, telegram?: string, photo?: string }` (все поля опциональны)

**Ответ:**
- 200: `{ user: User (без password), token: string }`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 404: `{ message: string }` - пользователь не найден
- 409: `{ message: string }` - пользователь с таким username уже существует
- 500: `{ message: string, error: any }` - ошибка сервера

**Доступ:** Требует роль PRIME

### GET `/api/auth/roles`

Получение списка всех доступных ролей.

**Запрос:**
- Query параметры отсутствуют

**Ответ:**
- 200: `Array<Role>`
- 500: `{ message: string, error: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

## Форматы данных

### User (без password)

```typescript
{
  _id: string;           // MongoDB ObjectId
  username: string;      // Уникальное имя пользователя
  fullname: string;      // Полное имя
  role?: string;         // Роль пользователя
  telegram?: string;     // Telegram контакт
  photo?: string;        // URL фотографии
  createdAt: Date;      // Дата создания
  updatedAt: Date;      // Дата обновления
}
```

### Role

```typescript
{
  _id: string;           // MongoDB ObjectId
  value: string;         // Значение роли (USER, ADMIN, PRIME)
  name?: string;         // Название роли
}
```

### Login/Update Response

```typescript
{
  user: User (без password);
  token: string;         // JWT токен для авторизации
}
```

