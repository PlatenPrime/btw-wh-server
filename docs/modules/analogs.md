# Модуль Analogs (Аналоги артикулов у конкурентов)

## Описание модуля

Модуль `analogs` решает задачи учёта аналогов артикулов (arts) на сайтах конкурентов. Он обеспечивает хранение ссылок на страницы товаров-аналогов у конкурентов с привязкой к конкуренту (Konk), производителю (Prod) и опционально к артикулу (Art). Поддерживаются CRUD-операции, пагинация и фильтрация по konkName, prodName и artikul.

## Сущности модуля

### Analog (Аналог)

Аналог — запись о товаре-аналоге у конкурента. Документ содержит: `konkName` — ключ конкурента (соответствует полю `name` в модели Konk); `prodName` — ключ производителя (соответствует полю `name` в модели Prod); `artikul` — артикул из arts, к которому привязан аналог (если не привязан — пустая строка); `nameukr` — при привязке к art подтягивается из документа Art; `url` — ссылка на страницу аналога у конкурента (обязательно); `title` — название аналога у конкурента; `imageUrl` — ссылка на изображение товара (обязательна, если аналог не привязан к art). Идентификатор документа генерируется MongoDB (`_id`). Документ имеет стандартные временные метки создания и обновления.

## Связи между сущностями

- **Konk:** по полю `konkName` аналог ссылается на конкурента (поле `name` в Konk). При получении аналога по id в ответ добавляются данные konk (id, name, title, imageUrl); при отсутствии документа Konk поля заполняются пустыми строками.
- **Prod:** по полю `prodName` аналог ссылается на производителя (поле `name` в Prod). Аналогично в getAnalogById в ответ добавляется prod (id, name, title, imageUrl); при отсутствии Prod — пустые строки.
- **Art:** при указании `artikul` при создании или обновлении аналога из документа Art подтягивается поле `nameukr`.

## Концепции и принятые решения

### Условная валидация при создании

При создании аналога (createAnalog) обязательны `konkName`, `prodName` и `url`. Если не указан (или пустой) `artikul`, обязательны также `title` и `imageUrl`. Если указан `artikul`, поле `nameukr` заполняется из Art; `title` и `imageUrl` при этом опциональны.

### Обогащение при получении по id

Эндпоинт getAnalogById возвращает документ аналога с добавленными полями `konk` и `prod` — объектами с полями id, name, title, imageUrl. Если подходящий Konk или Prod не найден по `konkName`/`prodName`, соответствующий объект заполняется пустыми строками.

### Пагинация и фильтры

getAnalogs поддерживает query-параметры `konkName`, `prodName`, `page`, `limit`. Сортировка по дате создания (сначала новые). Формат пагинации как в модуле zones (page, limit, total, totalPages, hasNext, hasPrev).

### Роли доступа

Чтение (все GET-эндпоинты) доступно роли USER. Создание и обновление — роли ADMIN. Удаление аналога разрешено только роли PRIME.

## API эндпоинты

- **GET `/api/analogs`** — список аналогов с пагинацией и фильтрами (konkName?, prodName?, page, limit). Доступ: USER.
- **GET `/api/analogs/id/:id`** — аналог по id с полями konk и prod. Доступ: USER.
- **GET `/api/analogs/prod/:prodName`** — аналоги по производителю. Доступ: USER.
- **GET `/api/analogs/konk/:konkName`** — аналоги по конкуренту. Доступ: USER.
- **GET `/api/analogs/artikul/:artikul`** — аналоги по артикулу. Доступ: USER.
- **POST `/api/analogs`** — создание аналога. Доступ: ADMIN.
- **PATCH `/api/analogs/id/:id`** — обновление аналога. Доступ: ADMIN.
- **DELETE `/api/analogs/id/:id`** — удаление аналога. Доступ: PRIME.

Детальное описание запросов и ответов — в [API документации](../api/analogs.md).
