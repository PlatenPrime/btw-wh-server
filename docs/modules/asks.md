# Модуль Asks

## Описание модуля

Модуль `asks` решает задачи управления заявками на товары. Он обеспечивает создание заявок пользователями на получение товаров со склада, отслеживание их статусов, фиксацию процесса снятия товара со склада (pull), а также уведомления о выполнении или отклонении заявок. Модуль является связующим звеном между пользователями, которые нуждаются в товарах, и складскими работниками, которые выполняют заявки.

## Сущности модуля

### Ask (Заявка)

Заявка представляет собой запрос на получение товара со склада. Это реальная задача, которую создает пользователь (asker) и которую выполняет складской работник (solver). Заявка содержит информацию о требуемом товаре (артикул, название, количество), комментарии, склад откуда нужно взять товар, статус выполнения, список действий которые нужно выполнить, информацию о фактически снятом количестве товара, а также историю событий произошедших с заявкой.

### AskEvent (Событие заявки)

Событие заявки представляет собой запись о действии, которое произошло с заявкой. Это может быть создание заявки, завершение, отклонение или снятие товара (pull). Каждое событие содержит информацию о пользователе который выполнил действие, дату и время события, а для событий типа pull также содержит детали о снятом товаре (паллета, количество, коробки).

## Связи между сущностями

- **Ask → User (asker)**: Многие к одному. Каждая заявка создается пользователем, который нуждается в товаре. Данные пользователя кэшируются в поле askerData для быстрого доступа без дополнительных запросов к базе данных.

- **Ask → User (solver)**: Многие к одному, опционально. Заявка может быть назначена на складского работника, который будет ее выполнять. Данные работника кэшируются в поле solverData.

- **AskEvent → Ask**: Многие к одному. Каждое событие принадлежит одной заявке и хранится в массиве events внутри заявки.

- **AskEvent → User**: Многие к одному. Каждое событие связано с пользователем, который его выполнил. Данные пользователя кэшируются в поле userData события.

## Концепции и принятые решения

### Жизненный цикл заявки

Заявка проходит через несколько статусов: new (новая) → processing (в обработке) → completed (завершена) или rejected (отклонена). Статус new присваивается при создании заявки. Статус processing может быть установлен при начале работы с заявкой. Статус completed устанавливается когда заявка успешно выполнена. Статус rejected устанавливается когда заявка отклонена по какой-либо причине.

### Снятие товара (Pull)

Процесс снятия товара со склада фиксируется через операцию pull. При этом создается событие типа pull с деталями о том, с какой паллеты, в каком количестве и сколько коробок было снято. Эта информация накапливается в полях pullQuant и pullBox заявки, что позволяет отслеживать общее количество снятого товара.

### История событий

Все действия с заявкой фиксируются в массиве events. Это позволяет отслеживать полную историю работы с заявкой: кто создал, кто выполнял, когда были сняты товары, кто завершил или отклонил. История событий является неизменяемой и служит для аудита и анализа работы системы.

### Кэширование данных пользователей

Данные пользователей (askerData, solverData, userData в событиях) кэшируются в заявке. Это позволяет избежать дополнительных запросов к базе данных при отображении заявок и обеспечивает целостность данных даже если пользователь изменит свои данные после создания заявки.

### Уведомления через Telegram

При завершении или отклонении заявки автоматически отправляется уведомление создателю заявки через Telegram, если у него указан telegram контакт. Это обеспечивает оперативную связь между складскими работниками и пользователями.

### Транзакции

Все операции изменения заявок выполняются в рамках MongoDB транзакций. Это гарантирует целостность данных и позволяет откатить изменения в случае ошибки.

## API эндпоинты

### POST `/api/asks`

Создание новой заявки.

**Запрос:**

- Body: `{ artikul: string, nameukr?: string, quant?: number, com?: string, sklad?: "pogrebi" | "merezhi", askerId: string }`

**Ответ:**

- 201: `Ask`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль USER

### GET `/api/asks/by-date`

Получение заявок по дате.

**Запрос:**

- Query параметры: `date` (string, формат YYYY-MM-DD)

**Ответ:**

- 200: `{ message: string, data: Array<Ask>, date: string, count: number, ...statistics }`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 500: `{ message: string, error?: string }` - ошибка сервера

**Доступ:** Требует роль USER

### GET `/api/asks/pulls`

Получение всех позиций для снятия по всем активным заявкам с автоматическим завершением готовых заявок.

**Запрос:**

- Query параметры отсутствуют

**Ответ:**

- 200: `{ message: string, data: { positionsBySector: Array<PositionsBySector>, completedAsks: Array<string> } }`
- 500: `{ message: string, error?: string }` - ошибка сервера

**Доступ:** Требует роль USER

**Примечание:** При каждом запросе автоматически проверяются заявки со статусом "processing" и завершаются те, у которых количество снятого товара уже удовлетворяет запрашиваемое количество. При автоматическом завершении создаются события и отправляются уведомления создателям заявок через Telegram.

### GET `/api/asks/:id`

Получение заявки по идентификатору.

**Запрос:**

- Path параметры: `id` (MongoDB ObjectId)

**Ответ:**

- 200: `Ask`
- 400: `{ message: string, errors?: array }` - неверный формат ID
- 404: `{ message: string }` - заявка не найдена
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль USER

### GET `/api/asks/:id/pull`

Получение позиций для снятия по заявке.

**Запрос:**

- Path параметры: `id` (MongoDB ObjectId)

**Ответ:**

- 200: `{ isPullRequired: boolean, positions: Array<PositionForPull>, remainingQuantity: number | null, status: "process" | "satisfied" | "no_poses" | "finished", message: string }`
- 400: `{ message: string, errors?: array }` - неверный формат ID
- 404: `{ message: string }` - заявка не найдена
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль USER

### PATCH `/api/asks/:id/pull`

Фиксация снятия товара по заявке.

**Запрос:**

- Path параметры: `id` (MongoDB ObjectId)
- Body: `{ solverId: string, action: string, pullAskData: { palletData: { _id: string, title: string }, quant: number, boxes: number } }`

**Ответ:**

- 200: `Ask`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 404: `{ message: string }` - заявка или пользователь не найдены
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### PATCH `/api/asks/:id/complete`

Завершение заявки.

**Запрос:**

- Path параметры: `id` (MongoDB ObjectId)
- Body: `{ solverId: string }`

**Ответ:**

- 200: `Ask`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 404: `{ message: string }` - заявка или пользователь не найдены
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

**Примечание:** Автоматически отправляется уведомление создателю заявки через Telegram, если указан telegram контакт.

### PATCH `/api/asks/:id/reject`

Отклонение заявки.

**Запрос:**

- Path параметры: `id` (MongoDB ObjectId)
- Body: `{ solverId: string }`

**Ответ:**

- 200: `Ask`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 404: `{ message: string }` - заявка или пользователь не найдены
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

**Примечание:** Автоматически отправляется уведомление создателю заявки через Telegram, если указан telegram контакт.

### PATCH `/api/asks/:id/actions`

Обновление списка действий заявки.

**Запрос:**

- Path параметры: `id` (MongoDB ObjectId)
- Body: `{ action: string, userId: string }`

**Ответ:**

- 200: `Ask`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 404: `{ message: string }` - заявка или пользователь не найдены
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### DELETE `/api/asks/:id`

Удаление заявки.

**Запрос:**

- Path параметры: `id` (MongoDB ObjectId)

**Ответ:**

- 200: `Ask`
- 400: `{ message: string, errors?: array }` - неверный формат ID
- 404: `{ message: string }` - заявка не найдена
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN, PRIME или быть владельцем заявки (asker)

## Форматы данных

### Ask

```typescript
{
  _id: string;                    // MongoDB ObjectId
  artikul: string;                // Артикул товара
  nameukr?: string;               // Название товара на украинском
  quant?: number;                 // Требуемое количество
  com?: string;                   // Комментарий
  sklad?: string;                 // Склад ("pogrebi" или "merezhi", по умолчанию "pogrebi")
  asker: string;                  // ObjectId пользователя-создателя
  askerData: {                    // Кэшированные данные создателя
    _id: string;
    fullname: string;
    telegram?: string;
    photo?: string;
  };
  solver?: string;                // ObjectId пользователя-исполнителя
  solverData?: {                  // Кэшированные данные исполнителя
    _id: string;
    fullname: string;
    telegram?: string;
    photo?: string;
  };
  status: "new" | "processing" | "completed" | "rejected";
  actions: string[];              // Список действий для выполнения
  pullQuant: number;              // Общее количество снятого товара
  pullBox: number;                // Общее количество снятых коробок
  events: Array<AskEvent>;        // История событий
  createdAt: Date;                // Дата создания
  updatedAt: Date;                // Дата обновления
}
```

### AskEvent

```typescript
{
  eventName: "create" | "complete" | "reject" | "pull";
  userData: {                     // Кэшированные данные пользователя
    _id: string;
    fullname: string;
    telegram?: string;
    photo?: string;
  };
  date: Date;                     // Дата и время события
  pullDetails?: {                 // Детали снятия (только для событий pull)
    palletData: {
      _id: string;
      title: string;
    };
    quant: number;                // Количество снятого товара
    boxes: number;                // Количество снятых коробок
  };
}
```

### PositionForPull

```typescript
{
  // Все поля из Pos
  plannedQuant: number | null; // Планируемое количество для снятия
}
```

### GetAskPullResponse

```typescript
{
  isPullRequired: boolean; // Нужно ли снимать товар
  positions: Array<PositionForPull>; // Позиции для снятия, отсортированные по сектору
  remainingQuantity: number | null; // Оставшееся количество для снятия
  status: "process" | "satisfied" | "no_poses" | "finished";
  message: string; // Сообщение о статусе
}
```

### PositionsBySector

```typescript
{
  sector: number; // Номер сектора паллеты
  positions: Array<PositionForPull>; // Позиции в данном секторе
}
```

### GetAsksPullsResponse

```typescript
{
  positionsBySector: Array<PositionsBySector>; // Позиции для снятия, сгруппированные по секторам паллет
  completedAsks: Array<string>; // ID заявок, которые были автоматически завершены
}
```
