# Модуль Zones

## Описание модуля

Модуль `zones` решает задачи управления зонами склада. Зоны представляют собой конкретные физические места хранения на складе и являются базовым уровнем организации пространства. Модуль обеспечивает создание и управление зонами, их привязку к сегментам для расчета секторов, а также работу со штрихкодами для физической идентификации зон. Модуль является основой для навигации по складу и организации хранения товаров.

## Сущности модуля

### Zone (Зона)

Зона представляет собой конкретное физическое место на складе, где хранятся товары. Это реальная локация склада, которая имеет уникальный идентификатор в формате "row-rack-shelf" (например, "42-5-2" означает ряд 42, стеллаж 5, полка 2), уникальный штрихкод для сканирования, сектор для организации пространства, и опциональную связь с сегментом для расчета сектора.

## Связи между сущностями

- **Zone → Seg**: Многие к одному, опционально. Зона может принадлежать сегменту, что определяет ее сектор. Связь осуществляется через поле seg, которое содержит ObjectId сегмента и опционально кэшированное название. Зоны без сегмента имеют сектор 0.

## Концепции и принятые решения

### Физические локации склада

Зоны представляют реальные физические места на складе. Идентификатор зоны в формате "row-rack-shelf" позволяет однозначно определить местонахождение товара. Формат поддерживает от 1 до 3 сегментов, каждый из которых может содержать от 1 до 2 цифр (1-99).

### Штрихкоды

Каждая зона имеет уникальный штрихкод (bar) в формате Code-128. Штрихкод используется для физической идентификации зон при сканировании и позволяет быстро находить нужные зоны на складе. Штрихкод должен быть положительным числом и уникальным в системе.

### Секторы

Сектор зоны определяет ее принадлежность к логической группе в структуре склада. Сектор рассчитывается на основе позиций блока и сегмента по формуле: `sector = blockOrder * 1000 + segOrder`. Зоны без сегмента имеют сектор 0. Секторы используются для организации пространства и упрощения навигации по складу.

### Опциональная связь с сегментами

Зона может существовать без связи с сегментом. Это позволяет гибко управлять структурой склада и добавлять зоны до их привязки к сегментам. Зоны без сегмента имеют сектор 0 и могут быть позже привязаны к сегментам.

### Массовые операции

Модуль поддерживает массовое создание зон через эндпоинт bulk и массовое обновление через upsert. Это критично при импорте данных из внешних систем или при первоначальной настройке склада.

### Экспорт в Excel

Модуль поддерживает экспорт всех зон в Excel файл. Это позволяет работать с данными о зонах во внешних системах и выполнять массовые операции.

### Пагинация и поиск

При получении списка зон поддерживается пагинация и поиск по названию. Это позволяет эффективно работать с большим количеством зон и быстро находить нужные зоны.

## API эндпоинты

### POST `/api/zones`

Создание новой зоны.

**Запрос:**
- Body: `{ title: string, bar: number, sector?: number }`

**Ответ:**
- 201: `{ message: string, data: Zone }`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 409: `{ message: string, duplicateFields?: array }` - зона с такими данными уже существует
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### GET `/api/zones`

Получение списка зон с пагинацией и поиском.

**Запрос:**
- Query параметры:
  - `page` (number, опционально, по умолчанию 1) - номер страницы
  - `limit` (number, опционально, по умолчанию 10, максимум 100) - количество элементов на странице
  - `search` (string, опционально) - поисковый запрос по title
  - `sortBy` (string, опционально, по умолчанию "sector") - поле для сортировки: "title", "bar", "sector", "createdAt"
  - `sortOrder` (string, опционально, по умолчанию "asc") - направление сортировки: "asc", "desc"

**Ответ:**
- 200: `{ message: string, data: Array<Zone>, pagination: { page: number, limit: number, total: number, totalPages: number, hasNext: boolean, hasPrev: boolean } }`
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### GET `/api/zones/:id`

Получение зоны по идентификатору.

**Запрос:**
- Path параметры: `id` (MongoDB ObjectId)

**Ответ:**
- 200: `{ message: string, data: Zone }`
- 400: `{ message: string }` - неверный формат ID
- 404: `{ message: string }` - зона не найдена
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### GET `/api/zones/title/:title`

Получение зоны по названию.

**Запрос:**
- Path параметры: `title` (string)

**Ответ:**
- 200: `{ message: string, data: Zone }`
- 400: `{ message: string }` - название не указано
- 404: `{ message: string }` - зона не найдена
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### GET `/api/zones/by-block/:blockId`

Получение всех зон блока (через сегменты).

**Запрос:**
- Path параметры: `blockId` (MongoDB ObjectId)

**Ответ:**
- 200: `{ message: string, data: Array<Zone> }`
- 400: `{ message: string, errors?: array }` - неверный формат ID
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### PUT `/api/zones/:id`

Обновление зоны.

**Запрос:**
- Path параметры: `id` (MongoDB ObjectId)
- Body: `{ title?: string, bar?: number, sector?: number }` (все поля опциональны, но хотя бы одно должно быть указано)

**Ответ:**
- 200: `{ message: string, data: Zone }`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 404: `{ message: string }` - зона не найдена
- 409: `{ message: string, duplicateFields?: array }` - зона с такими данными уже существует
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### DELETE `/api/zones/:id`

Удаление зоны.

**Запрос:**
- Path параметры: `id` (MongoDB ObjectId)

**Ответ:**
- 200: `{ message: string, data: Zone }`
- 400: `{ message: string }` - неверный формат ID
- 404: `{ message: string }` - зона не найдена
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### POST `/api/zones/upsert`

Массовое создание или обновление зон.

**Запрос:**
- Body: `{ zones: Array<{ title: string, bar: number }> }` (массив от 1 до 1000 элементов)

**Ответ:**
- 200: `{ message: string, results: { created: number, skipped: number, errors: Array<{ index: number, error: string, data: object }> } }`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### GET `/api/zones/export`

Экспорт всех зон в Excel файл.

**Запрос:**
- Query параметры отсутствуют

**Ответ:**
- 200: Excel файл (application/vnd.openxmlformats-officedocument.spreadsheetml.sheet)
- 404: `{ message: string }` - зоны не найдены
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

## Форматы данных

### Zone

```typescript
{
  _id: string;                    // MongoDB ObjectId
  title: string;                   // Идентификатор зоны (формат: "row-rack-shelf")
  bar: number;                     // Уникальный штрихкод
  sector: number;                  // Сектор зоны (рассчитывается или 0)
  seg?: {                          // Связь с сегментом (опционально)
    id: string;                    // ObjectId сегмента
    title?: string;                // Кэшированное название сегмента
  };
  createdAt: Date;                 // Дата создания
  updatedAt: Date;                 // Дата обновления
}
```

