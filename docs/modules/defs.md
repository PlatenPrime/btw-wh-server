# Модуль Defs

## Описание модуля

Модуль `defs` решает задачи расчета и управления дефицитами товаров. Он обеспечивает сравнение остатков товаров на складе с остатками на внешнем сайте (sharik.ua), определение статусов дефицита на основе лимитов товаров, а также связь с заявками для отслеживания уже созданных запросов на пополнение. Модуль является основой для планирования закупок и контроля остатков товаров.

## Сущности модуля

### Def (Расчет дефицитов)

Расчет дефицитов представляет собой результат сравнения остатков товаров на складе с остатками на внешнем сайте. Это снимок состояния дефицитов на момент расчета, который содержит информацию о каждом товаре с дефицитом, общее количество дефицитов, количество критических и лимитных дефицитов, а также дату расчета.

### DeficitItem (Элемент дефицита)

Элемент дефицита представляет собой информацию о дефиците конкретного товара. Он содержит название товара, количество на складе, количество на сайте, разницу между ними, сумму количества на складе и лимита, а также статус дефицита (limited или critical).

## Связи между сущностями

- **Def → Art**: Косвенная связь через артикулы. Каждый элемент дефицита связан с артикулом через ключ в объекте result, который содержит артикул товара.

- **Def → Ask**: Косвенная связь через артикулы. При получении дефицитов они обогащаются информацией о существующих заявках на пополнение товаров, что позволяет видеть какие товары уже запрошены.

## Концепции и принятые решения

### Сравнение остатков с внешним сайтом

Модуль сравнивает остатки товаров на складе (из модуля poses) с остатками на внешнем сайте sharik.ua (через модуль comps). Это позволяет выявлять расхождения и определять дефициты товаров.

### Статусы дефицита

Дефицит может иметь два статуса: limited (лимитный) и critical (критический). Статус определяется на основе суммы количества товара на складе и лимита товара (defLimit = quant + artLimit). Если defLimit меньше определенного порога, дефицит считается критическим, иначе лимитным.

### Лимиты товаров

Для каждого товара может быть установлен лимит минимального количества (из модуля arts). Лимит используется при расчете дефицитов для определения статуса и планирования закупок.

### Связь с заявками

При получении дефицитов они обогащаются информацией о существующих заявках на пополнение товаров. Это позволяет видеть какие товары уже запрошены и избегать дублирования заявок.

### Асинхронный расчет

Расчет дефицитов является ресурсоемкой операцией, так как требует запросов к внешнему сайту для каждого товара. Расчет выполняется асинхронно, а статус расчета отслеживается через специальный эндпоинт.

### Статус расчета

Модуль отслеживает статус расчета дефицитов (в процессе, завершен, ошибка). Это позволяет пользователям видеть прогресс расчета и знать когда результаты будут готовы.

### Хранение результатов

Результаты расчета дефицитов сохраняются в базе данных. Это позволяет отслеживать историю дефицитов и анализировать изменения во времени.

### Массовые операции

Модуль поддерживает массовый расчет дефицитов для всех товаров одновременно. Это критично для регулярного мониторинга остатков и планирования закупок.

## API эндпоинты

### POST `/api/defs/calculate`

Запуск расчета дефицитов.

**Запрос:**
- Body отсутствует

**Ответ:**
- 201: `{ success: boolean, message: string, data: { total: number, totalCriticalDefs: number, totalLimitDefs: number, createdAt: Date } }`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 500: `{ success: boolean, message: string, error?: string }` - ошибка сервера

**Доступ:** Требует роль ADMIN

**Примечание:** Операция выполняется асинхронно. Статус расчета можно отслеживать через эндпоинт `/api/defs/calculation-status`.

### GET `/api/defs/latest`

Получение последнего расчета дефицитов с информацией о заявках.

**Запрос:**
- Query параметры отсутствуют

**Ответ:**
- 200: `{ exists: boolean, message: string, data: { _id: string, result: IDeficitCalculationResultWithAsks, total: number, totalCriticalDefs: number, totalLimitDefs: number, createdAt: Date, updatedAt: Date } | null }`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 500: `{ success: boolean, message: string, error?: string }` - ошибка сервера

**Доступ:** Требует роль USER

**Примечание:** Результат обогащается информацией о существующих заявках для каждого товара.

### GET `/api/defs/calculation-status`

Получение статуса расчета дефицитов.

**Запрос:**
- Query параметры отсутствуют

**Ответ:**
- 200: `{ success: boolean, data: { isCalculating: boolean, progress?: number, error?: string } }`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 500: `{ success: boolean, message: string, error?: string }` - ошибка сервера

**Доступ:** Требует роль USER

## Форматы данных

### Def

```typescript
{
  _id: string;                    // MongoDB ObjectId
  result: {                        // Результат расчета дефицитов (ключ - артикул)
    [artikul: string]: IDeficitItem;
  };
  total: number;                   // Общее количество дефицитов
  totalCriticalDefs: number;        // Количество критических дефицитов
  totalLimitDefs: number;           // Количество лимитных дефицитов
  createdAt: Date;                 // Дата создания
  updatedAt: Date;                  // Дата обновления
}
```

### IDeficitItem

```typescript
{
  nameukr: string;                 // Название товара на украинском
  quant: number;                   // Количество товара на складе
  sharikQuant: number;             // Количество товара на сайте sharik.ua
  difQuant: number;                // Разница (sharikQuant - quant)
  defLimit: number;                // Сумма количества на складе и лимита (quant + artLimit)
  status: "limited" | "critical";  // Статус дефицита
}
```

### IDeficitItemWithAsk

```typescript
{
  // Все поля из IDeficitItem
  existingAsk: {                   // Информация о существующей заявке (если есть)
    _id: string;
    status: string;
    createdAt: Date;
    askerName: string;
    askerId: string;
  } | null;
}
```

### CalculationStatus

```typescript
{
  isCalculating: boolean;           // Флаг выполнения расчета
  progress?: number;                // Прогресс расчета (0-100)
  error?: string;                   // Сообщение об ошибке (если есть)
}
```

