# Модуль Arts

## Описание модуля

Модуль `arts` решает задачи управления артикулами товаров в системе. Он обеспечивает хранение информации о товарах, их версионирование через маркеры, интеграцию с внешними системами (Btrade) для получения актуальных данных о товарах, а также управление зонами хранения и лимитами товаров. Модуль является основой для работы с товарным каталогом и позволяет отслеживать изменения в номенклатуре товаров.

## Сущности модуля

### Art (Артикул)

Артикул представляет собой товар в системе. Это реальный физический товар, который хранится на складе и продается. Артикул имеет уникальный идентификатор (artikul), названия на разных языках (украинский, русский), зону хранения где он должен находиться, лимит минимального количества на складе, маркер версии для отслеживания актуальности данных, а также информацию об остатках во внешней системе Btrade.

### BtradeStock

BtradeStock представляет информацию об остатках товара во внешней системе Btrade. Это данные о количестве товара на витрине Btrade и дате последнего обновления этой информации. Используется для синхронизации данных между системами.

## Связи между сущностями

- **Art → Zone**: Многие к одному. Каждый артикул привязан к зоне хранения, которая определяет физическое место на складе где должен находиться товар. Связь осуществляется через строковое поле zone, которое содержит идентификатор зоны.

## Концепции и принятые решения

### Маркеры версионирования

Для отслеживания актуальности данных об артикулах используется система маркеров. Маркер представляет собой дату в формате YYYYMMDD (например, "20251123" для 23 ноября 2025 года) в часовом поясе Europe/Kyiv. При массовом обновлении артикулов (upsert) всем артикулам автоматически присваивается текущий маркер, если он не указан явно. Это позволяет отслеживать какие артикулы были обновлены в последний раз и удалять устаревшие версии.

### Интеграция с Btrade

Модуль интегрируется с внешней системой Btrade для получения актуальной информации о товарах. Это позволяет синхронизировать данные о названиях товаров, ценах и остатках. Информация об остатках Btrade хранится в поле btradeStock с датой последнего обновления.

### Зоны хранения

Каждый артикул привязан к зоне хранения. Зона определяет физическое место на складе где должен находиться товар. Это позволяет организовать логистику и быстро находить товары на складе.

### Лимиты товаров

Для каждого артикула может быть установлен лимит - минимальное количество товара, которое должно быть на складе. Это используется для контроля остатков и планирования закупок.

### Массовые операции

Модуль поддерживает массовые операции для эффективной работы с большими объемами данных. Операция upsert позволяет создавать или обновлять множество артикулов за один запрос, что критично при импорте данных из внешних систем.

## API эндпоинты

### GET `/api/arts`

Получение списка артикулов с пагинацией и поиском.

**Запрос:**
- Query параметры:
  - `page` (string, опционально, по умолчанию "1") - номер страницы
  - `limit` (string, опционально, по умолчанию "10") - количество элементов на странице
  - `search` (string, опционально) - поисковый запрос по artikul, nameukr или namerus

**Ответ:**
- 200: `{ data: Array<Art>, total: number, page: number, totalPages: number }`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль USER

### GET `/api/arts/id/:id`

Получение артикула по идентификатору.

**Запрос:**
- Path параметры: `id` (MongoDB ObjectId)

**Ответ:**
- 200: `Art`
- 400: `{ message: string, errors?: array }` - неверный формат ID
- 404: `{ message: string }` - артикул не найден
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль USER

### GET `/api/arts/artikul/:artikul`

Получение артикула по номеру артикула.

**Запрос:**
- Path параметры: `artikul` (string)

**Ответ:**
- 200: `Art`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 404: `{ message: string }` - артикул не найден
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль USER

### GET `/api/arts/zone/:zone`

Получение артикулов по зоне хранения.

**Запрос:**
- Path параметры: `zone` (string) - идентификатор зоны

**Ответ:**
- 200: `{ data: Array<Art>, total: number }`
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль USER

### GET `/api/arts/btrade/:artikul`

Получение информации о товаре из системы Btrade.

**Запрос:**
- Path параметры: `artikul` (string)

**Ответ:**
- 200: `{ exists: boolean, message: string, data: { nameukr: string, price: number, quantity: number } | null }`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 500: `{ message: string, error?: string }` - ошибка сервера

**Доступ:** Требует роль USER

### POST `/api/arts/upsert`

Массовое создание или обновление артикулов.

**Запрос:**
- Body: `Array<{ artikul: string, zone: string, nameukr?: string, namerus?: string, limit?: number, marker?: string }>`

**Ответ:**
- 200: `{ message: string, result: object }` - результат операции MongoDB bulkWrite
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 401: `{ message: string }` - не авторизован
- 403: `{ message: string }` - недостаточно прав
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### DELETE `/api/arts/without-latest-marker`

Удаление всех артикулов без последнего актуального маркера.

**Запрос:**
- Body отсутствует

**Ответ:**
- 200: `{ message: string, result: { deletedCount: number, latestMarker: string | null } }`
- 401: `{ message: string }` - не авторизован
- 403: `{ message: string }` - недостаточно прав (требуется PRIME)
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль PRIME

### GET `/api/arts/export`

Экспорт всех артикулов в Excel файл.

**Запрос:**
- Query параметры отсутствуют

**Ответ:**
- 200: Excel файл (application/vnd.openxmlformats-officedocument.spreadsheetml.sheet)
- 404: `{ message: string }` - артикулы не найдены
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### GET `/api/arts/export-with-stocks`

Экспорт всех артикулов в Excel файл с данными о запасах и витрине.

**Запрос:**
- Query параметры отсутствуют

**Ответ:**
- 200: Excel файл (application/vnd.openxmlformats-officedocument.spreadsheetml.sheet)
- 404: `{ message: string }` - артикулы не найдены
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### PATCH `/api/arts/:id/limit`

Обновление лимита артикула.

**Запрос:**
- Path параметры: `id` (MongoDB ObjectId)
- Body: `{ limit: number }` (неотрицательное число)

**Ответ:**
- 200: `Art`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 404: `{ message: string }` - артикул не найден
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### PATCH `/api/arts/:artikul/btrade-stock`

Обновление информации об остатках Btrade для одного артикула.

**Запрос:**
- Path параметры: `artikul` (string)
- Body отсутствует

**Ответ:**
- 200: `Art`
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 404: `{ message: string }` - артикул не найден
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

### POST `/api/arts/btrade-stock/update-all`

Обновление информации об остатках Btrade для всех артикулов.

**Запрос:**
- Body отсутствует

**Ответ:**
- 202: `{ message: string }` - процесс обновления запущен
- 400: `{ message: string, errors?: array }` - ошибка валидации
- 500: `{ message: string, error?: any }` - ошибка сервера

**Доступ:** Требует роль ADMIN

**Примечание:** Операция выполняется асинхронно в фоне, ответ возвращается сразу после запуска процесса.

## Форматы данных

### Art

```typescript
{
  _id: string;                    // MongoDB ObjectId
  artikul: string;                // Уникальный номер артикула
  nameukr?: string;               // Название на украинском
  namerus?: string;               // Название на русском
  zone: string;                   // Идентификатор зоны хранения
  limit?: number;                 // Лимит минимального количества
  marker?: string;               // Маркер версии (YYYYMMDD)
  btradeStock?: {                 // Информация об остатках Btrade
    value: number;                // Количество на витрине
    date: Date;                   // Дата обновления
  };
  createdAt?: Date;                // Дата создания
  updatedAt?: Date;               // Дата обновления
}
```

### Btrade Art Info

```typescript
{
  nameukr: string;                // Название товара
  price: number;                  // Цена
  quantity: number;               // Количество на витрине
}
```

