## Модуль Pallet-groups

### Описание модуля

Модуль `pallet-groups` решает задачу логического объединения паллет склада в управляемые группы. Группа паллет существует не как отдельный физический объект на складе, а как удобная логическая сущность для навигации, визуализации и управления пространством. Через группы можно:

- организовать паллеты в осмысленные кластеры (например, «горячие паллеты у ворот», «дальние остатки», «приоритетные паллеты для отгрузки»);
- задать порядок групп, который определяет порядок паллет в общем пространстве склада;
- централизованно управлять секторами паллет через перерасчёт, чтобы отразить этот порядок в других модулях и интерфейсах.

Модуль не создаёт новые физические уровни хранения, а переиспользует уже существующие паллеты из модуля `pallets`, добавляя над ними дополнительный слой логической сортировки.

### Сущности модуля

#### PalletGroup (Группа паллет)

Группа паллет — это логическая коллекция ссылок на уже существующие паллеты. Она описывается:

- читаемым названием;
- порядком среди других групп;
- списком паллет, которые к ней относятся.

Эта сущность отражает, как паллеты должны быть разложены и показаны в интерфейсах, но не меняет физическую привязку паллет к рядам или зонам.

### Связи между сущностями

- **PalletGroup → Pallet**: один ко многим. Каждая группа содержит массив идентификаторов паллет, которые в неё входят. Одна паллета может принадлежать максимум одной группе, так как в паллете кэшируется ссылка на группу.
- **Pallet → PalletGroup**: опциональная связь через кэшированные данные. В паллете хранится объект с идентификатором и названием группы, к которой она относится. Это позволяет быстро понять, в какую группу включена паллета, без дополнительного запроса за группой.
- **PalletGroup и сектора паллет**: порядок групп и порядок паллет внутри каждой группы используются для расчёта сектора паллеты. Таким образом, группы напрямую влияют на то, в каком порядке паллеты будут восприниматься в системе и интерфейсах.

Модуль `pallet-groups` тесно связан с модулем `pallets`: группы управляют только уже существующими паллетами, не создавая и не удаляя сами паллеты.

### Концепции и принятые решения

#### Логические кластеры паллет

Группы паллет используются как уровень логической сортировки поверх существующей структуры рядов, паллет и позиций. Это позволяет:

- объединять паллеты из разных рядов в единые кластеры;
- управлять тем, как эти кластеры будут показаны пользователю;
- готовить данные для интерфейсов с drag-and-drop и сценариями перераскладки.

В типичном сценарии группы соответствуют крупным визуальным блокам или колонкам на схеме склада.

#### Уникальность названия группы

Название группы паллет должно быть уникальным. Это упрощает поиск и работу с группами как для пользователей, так и для интеграций. Конфликт названия трактуется как ошибка при создании новой группы.

#### Порядок групп

Каждая группа имеет числовое поле порядка. Этот порядок:

- определяет относительное расположение групп при отображении;
- используется как основной компонент при расчёте сектора паллеты.

Меньшее значение порядка означает, что группа считается более «ранней» и будет расположена в начале при сортировке по возрастанию.

#### Расчёт сектора паллеты

Сектор паллеты в контексте групп определяется комбинацией:

- порядка группы;
- позиции паллеты внутри массива паллет этой группы.

Формула концептуально выглядит как функция от порядка группы и порядкового номера паллеты внутри группы. Это обеспечивает:

- стабильный и предсказуемый сектор для каждой паллеты;
- возможность перестраивать сектора массово при смене порядка групп или состава паллет в группе.

Паллеты, не входящие ни в одну группу, получают нулевой сектор, а кэшированная связь с группой у них отсутствует. Это явно показывает, что такие паллеты находятся вне логических кластеров.

#### Массовые операции над секторами

Модуль поддерживает два ключевых сценария:

- полный сброс секторов всех паллет и очистку ссылки на группу — когда нужно обнулить текущее логическое разбиение;
- перерасчёт секторов на основе актуального состава групп и их порядка — когда нужно синхронизировать логическую структуру групп с данными паллет.

Обе операции выполняются массово и предназначены для административных сценариев.

### API эндпоинты

Все эндпоинты модуля используют базовый путь `/api/pallet-groups` и требуют аутентификации. Конкретные роли доступа указаны ниже.

- **GET `/api/pallet-groups`**  
  Возвращает список всех групп паллет, отсортированных по полю порядка по возрастанию.  
  Ответ содержит для каждой группы её идентификатор, название и порядок.  
  Доступ: роль пользователя уровня USER и выше.

- **GET `/api/pallet-groups/:id`**  
  Возвращает одну группу паллет по идентификатору вместе с краткими данными по всем входящим в неё паллетам.  
  При неверном идентификаторе или отсутствии группы возвращает соответствующую ошибку.  
  Доступ: роль пользователя уровня USER и выше.

- **GET `/api/pallet-groups/free-pallets`**  
  Возвращает список паллет, не входящих ни в одну группу (в формате краткого DTO), для использования при выборе паллет при добавлении в группу.  
  Доступ: роль пользователя уровня USER и выше.

- **POST `/api/pallet-groups`**  
  Создаёт новую группу паллет.  
  В теле ожидаются данные с названием и порядком группы. При попытке создать группу с уже существующим названием возвращается ошибка конфликта.  
  Доступ: роль ADMIN.

- **PUT `/api/pallet-groups/:id`**  
  Обновляет существующую группу.  
  Можно изменить название, порядок или оба поля сразу. В ответе возвращается обновлённое состояние группы с массивом идентификаторов входящих в неё паллет.  
  Доступ: роль ADMIN.

- **DELETE `/api/pallet-groups/:id`**  
  Удаляет группу паллет по идентификатору.  
  При удалении группа перестаёт участвовать в расчёте секторов, но сами паллеты остаются и могут быть перераспределены или сброшены через другие операции.  
  Доступ: роль PRIME.

- **POST `/api/pallet-groups/set-pallets`**  
  Устанавливает точный состав паллет для указанной группы.  
  В теле передаются идентификатор группы и список идентификаторов паллет, которые должны входить в эту группу. В результате группа получает обновлённый список паллет, а в ответе возвращаются данные группы с краткими данными по этим паллетам.  
  Доступ: роль ADMIN.

- **POST `/api/pallet-groups/unlink-pallet`**  
  Убирает одну паллету из её текущей группы.  
  В теле или параметрах передаётся идентификатор паллеты. Если паллета не привязана ни к одной группе, возвращается ошибка о том, что связь отсутствует. В ответе при успешной отвязке возвращаются данные группы с обновлённым списком паллет.  
  Доступ: роль ADMIN.

- **POST `/api/pallet-groups/reset-pallets-sectors`**  
  Массово сбрасывает секторы всех паллет и очищает у них кэшированную ссылку на группу.  
  Используется в ситуациях, когда требуется полностью пересобрать логику группировки и распределения секторов. В ответе возвращается статистика по количеству обработанных паллет.  
  Доступ: роль ADMIN.

- **POST `/api/pallet-groups/recalculate-pallets-sectors`**  
  Пересчитывает секторы паллет на основе текущих групп и порядка паллет внутри каждой группы.  
  В результате каждая паллета либо получает новый сектор и ссылку на свою группу, либо остаётся с нулевым сектором и без группы, если не входит ни в одну. В ответе возвращается количество обновлённых паллет и число обработанных групп.  
  Доступ: роль ADMIN.

### Форматы данных

#### PalletGroup

Группа паллет описывается следующими ключевыми полями:

- идентификатор группы;
- уникальное строковое название;
- числовой порядок, начиная с единицы;
- массив идентификаторов паллет, входящих в группу;
- служебные даты создания и обновления.

Паллеты в массиве хранятся в порядке, который соответствует желаемому порядку отображения внутри группы.

#### Паллета в контексте групп

Для взаимодействия с модулем `pallet-groups` важны следующие моменты о паллете:

- каждая паллета может иметь сектор, отражающий её положение в общей логической сетке;
- паллета может содержать кэшированную связь с группой, включающую идентификатор и название группы;
- паллеты, не входящие ни в одну группу, имеют нулевой сектор и не содержат кэшированного объекта группы.

Таким образом, модуль `pallet-groups` определяет, как именно паллеты разбиваются на кластеры и как это разбиение отображается через сектора и связи в других модулях и интерфейсах.
