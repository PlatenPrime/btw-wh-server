# üîê –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–æ–ª–µ–π –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
- [–†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π](#—Ä–æ–ª–∏-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- [–ü—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏](#–ø—Ä–æ—Ü–µ—Å—Å-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
- [–†–∞–±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–∞–º–∏](#—Ä–∞–±–æ—Ç–∞-—Å-—Ç–æ–∫–µ–Ω–∞–º–∏)
- [–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤](#–ø—Ä–∏–º–µ—Ä—ã-–∑–∞–ø—Ä–æ—Å–æ–≤)
- [–ö–æ–¥—ã –æ—à–∏–±–æ–∫](#–∫–æ–¥—ã-–æ—à–∏–±–æ–∫)
- [–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏](#–ª—É—á—à–∏–µ-–ø—Ä–∞–∫—Ç–∏–∫–∏)

---

## –û–±–∑–æ—Ä

–°–µ—Ä–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç JWT (JSON Web Token) –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –í—Å–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç –Ω–∞–ª–∏—á–∏—è –≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `Authorization`.

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (checkAuth)**: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å JWT —Ç–æ–∫–µ–Ω–∞
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π (checkRoles)**: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (checkOwnership)**: –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ä–µ—Å—É—Ä—Å—ã

---

## –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–í —Å–∏—Å—Ç–µ–º–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç—Ä–∏ —Ç–∏–ø–∞ —Ä–æ–ª–µ–π —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π (–æ—Ç –≤—ã—Å—à–µ–π –∫ –Ω–∏–∑—à–µ–π):

### 1. **PRIME** (–°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

- –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É —Å–∏—Å—Ç–µ–º—ã
- –ú–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –ª—é–±—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ù–µ –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

### 2. **ADMIN** (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)

- –ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —É–¥–∞–ª—è—Ç—å —Å—É—â–Ω–æ—Å—Ç–∏
- –ú–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å asks –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –î–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º

### 3. **USER** (–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

- –ú–æ–∂–µ—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
- –ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ–∏ asks
- –ú–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ asks
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

---

## –ü—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**Endpoint:** `POST /api/auth/register`

**Request Body:**

```json
{
  "username": "john_doe",
  "password": "SecurePassword123!",
  "fullname": "John Doe",
  "telegram": "@johndoe",
  "photo": "https://example.com/photo.jpg",
  "role": "USER"
}
```

**Response (Success - 201):**

```json
{
  "user": {
    "_id": "507f1f77bcf86cd799439011",
    "username": "john_doe",
    "fullname": "John Doe",
    "role": "USER",
    "telegram": "@johndoe",
    "photo": "https://example.com/photo.jpg",
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  }
}
```

### 2. –í—Ö–æ–¥ (Login)

**Endpoint:** `POST /api/auth/login`

**Request Body:**

```json
{
  "username": "john_doe",
  "password": "SecurePassword123!"
}
```

**Response (Success - 200):**

```json
{
  "user": {
    "_id": "507f1f77bcf86cd799439011",
    "username": "john_doe",
    "fullname": "John Doe",
    "role": "USER",
    "telegram": "@johndoe",
    "photo": "https://example.com/photo.jpg"
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjUwN2YxZjc3YmNmODZjZDc5OTQzOTAxMSIsInJvbGUiOiJVU0VSIiwiaWF0IjoxNzA1MzE1ODAwLCJleHAiOjE3MDU0MDIyMDB9.example_signature"
}
```

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ:

```typescript
// LocalStorage
localStorage.setItem("authToken", response.token);
localStorage.setItem("user", JSON.stringify(response.user));

// SessionStorage (–±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
sessionStorage.setItem("authToken", response.token);

// Cookie (—Å httpOnly –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ)
document.cookie = `authToken=${response.token}; Secure; SameSite=Strict`;
```

---

## –†–∞–±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–∞–º–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JWT —Ç–æ–∫–µ–Ω–∞

JWT —Ç–æ–∫–µ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ payload:

```json
{
  "id": "507f1f77bcf86cd799439011", // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  "role": "USER", // –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  "iat": 1705315800, // –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è (issued at)
  "exp": 1705402200 // –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è (expires)
}
```

### –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞

- **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:** 24 —á–∞—Å–∞
- –¢–æ–∫–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
- –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∫ –∑–∞–ø—Ä–æ—Å–∞–º

**–í—Å–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫:**

```
Authorization: Bearer <–≤–∞—à_—Ç–æ–∫–µ–Ω>
```

#### –ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

**Axios:**

```typescript
import axios from "axios";

// –°–æ–∑–¥–∞–Ω–∏–µ axios –∏–Ω—Å—Ç–∞–Ω—Å–∞ —Å —Ç–æ–∫–µ–Ω–æ–º
const api = axios.create({
  baseURL: "http://localhost:3000/api",
});

// Interceptor –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
api.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem("authToken");
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => Promise.reject(error)
);

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
const getUsers = async () => {
  const response = await api.get("/auth/users");
  return response.data;
};
```

**Fetch API:**

```typescript
const getUsers = async () => {
  const token = localStorage.getItem("authToken");

  const response = await fetch("http://localhost:3000/api/auth/users", {
    method: "GET",
    headers: {
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json",
    },
  });

  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }

  return await response.json();
};
```

**React Query:**

```typescript
import { useQuery } from "@tanstack/react-query";
import axios from "axios";

const useUsers = () => {
  return useQuery({
    queryKey: ["users"],
    queryFn: async () => {
      const token = localStorage.getItem("authToken");
      const { data } = await axios.get("/api/auth/users", {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });
      return data;
    },
  });
};
```

---

## –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

### –ú–∞—Ç—Ä–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º

| –ú–æ–¥—É–ª—å      | –ú–µ—Ç–æ–¥  | Endpoint                   | USER         | ADMIN        | PRIME        |
| ----------- | ------ | -------------------------- | ------------ | ------------ | ------------ |
| **Auth**    |
|             | POST   | `/auth/login`              | ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π | ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π | ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π |
|             | POST   | `/auth/register`           | ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π | ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π | ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π |
|             | GET    | `/auth/users`              | ‚ùå           | ‚úÖ           | ‚úÖ           |
|             | GET    | `/auth/users/:id`          | ‚úÖ           | ‚úÖ           | ‚úÖ           |
|             | GET    | `/auth/me/:id`             | ‚úÖ           | ‚úÖ           | ‚úÖ           |
|             | PUT    | `/auth/users/:userId`      | ‚ùå           | ‚úÖ           | ‚úÖ           |
|             | GET    | `/auth/roles`              | ‚ùå           | ‚úÖ           | ‚úÖ           |
| **Asks**    |
|             | POST   | `/asks`                    | ‚úÖ           | ‚úÖ           | ‚úÖ           |
|             | GET    | `/asks/by-date`            | ‚úÖ           | ‚úÖ           | ‚úÖ           |
|             | GET    | `/asks/:id`                | ‚úÖ           | ‚úÖ           | ‚úÖ           |
|             | PUT    | `/asks/:id`                | ‚úÖ (—Å–≤–æ–π)    | ‚úÖ           | ‚úÖ           |
|             | DELETE | `/asks/:id`                | ‚úÖ (—Å–≤–æ–π)    | ‚úÖ           | ‚úÖ           |
|             | PATCH  | `/asks/:id/complete`       | ‚ùå           | ‚úÖ           | ‚úÖ           |
|             | PATCH  | `/asks/:id/reject`         | ‚ùå           | ‚úÖ           | ‚úÖ           |
|             | PATCH  | `/asks/:id/actions`        | ‚ùå           | ‚úÖ           | ‚úÖ           |
| **Arts**    |
|             | GET    | `/arts/*`                  | ‚úÖ           | ‚úÖ           | ‚úÖ           |
|             | PATCH  | `/arts/:id/limit`          | ‚ùå           | ‚úÖ           | ‚úÖ           |
|             | POST   | `/arts/upsert`             | ‚ùå           | ‚úÖ           | ‚úÖ           |
| **Pallets** |
|             | GET    | `/pallets/*`               | ‚úÖ           | ‚úÖ           | ‚úÖ           |
|             | POST   | `/pallets/*`               | ‚ùå           | ‚úÖ           | ‚úÖ           |
|             | PUT    | `/pallets/:id`             | ‚ùå           | ‚úÖ           | ‚úÖ           |
|             | DELETE | `/pallets/*`               | ‚ùå           | ‚úÖ           | ‚úÖ           |
| **Poses**   |
|             | GET    | `/poses/*`                 | ‚úÖ           | ‚úÖ           | ‚úÖ           |
|             | POST   | `/poses/*`                 | ‚ùå           | ‚úÖ           | ‚úÖ           |
|             | PUT    | `/poses/:id`               | ‚ùå           | ‚úÖ           | ‚úÖ           |
|             | DELETE | `/poses/:id`               | ‚ùå           | ‚úÖ           | ‚úÖ           |
| **Rows**    |
|             | GET    | `/rows/*`                  | ‚úÖ           | ‚úÖ           | ‚úÖ           |
|             | POST   | `/rows`                    | ‚ùå           | ‚úÖ           | ‚úÖ           |
|             | PUT    | `/rows/:id`                | ‚ùå           | ‚úÖ           | ‚úÖ           |
|             | DELETE | `/rows/:id`                | ‚ùå           | ‚úÖ           | ‚úÖ           |
| **Defs**    |
|             | GET    | `/defs/latest`             | ‚úÖ           | ‚úÖ           | ‚úÖ           |
|             | GET    | `/defs/calculation-status` | ‚úÖ           | ‚úÖ           | ‚úÖ           |
|             | POST   | `/defs/calculate`          | ‚ùå           | ‚úÖ           | ‚úÖ           |

---

## –ö–æ–¥—ã –æ—à–∏–±–æ–∫

### –û—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (401 Unauthorized)

| –ö–æ–¥                     | –û–ø–∏—Å–∞–Ω–∏–µ                               | –î–µ–π—Å—Ç–≤–∏–µ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ                       |
| ----------------------- | -------------------------------------- | ------------------------------------------- |
| `NO_TOKEN`              | –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ          | –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞             |
| `INVALID_TOKEN_FORMAT`  | –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞ (–Ω–µ Bearer)     | –û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –≤—Ö–æ–¥       |
| `TOKEN_EXPIRED`         | –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫                            | –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –≤—Ö–æ–¥ |
| `INVALID_TOKEN`         | –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω                       | –û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –≤—Ö–æ–¥       |
| `INVALID_TOKEN_PAYLOAD` | –í —Ç–æ–∫–µ–Ω–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è | –û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –≤—Ö–æ–¥       |
| `USER_DATA_MISSING`     | Middleware checkAuth –Ω–µ –±—ã–ª –ø—Ä–∏–º–µ–Ω–µ–Ω   | –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å            |

### –û—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–∞ (403 Forbidden)

| –ö–æ–¥                        | –û–ø–∏—Å–∞–Ω–∏–µ                                    | –î–µ–π—Å—Ç–≤–∏–µ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ                   |
| -------------------------- | ------------------------------------------- | --------------------------------------- |
| `INVALID_USER_ROLE`        | –ù–µ–≤–∞–ª–∏–¥–Ω–∞—è —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                | –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É, —Å–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π |
| `INSUFFICIENT_PERMISSIONS` | –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏   | –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ –ø—Ä–∞–≤  |
| `NOT_RESOURCE_OWNER`       | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —Ä–µ—Å—É—Ä—Å–∞ | –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω"  |

### –ü—Ä–∏–º–µ—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

**React + Axios:**

```typescript
import { useNavigate } from "react-router-dom";
import { toast } from "react-hot-toast";

// Interceptor –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
api.interceptors.response.use(
  (response) => response,
  (error) => {
    const { response } = error;

    if (response?.status === 401) {
      const errorCode = response.data?.code;

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫
      switch (errorCode) {
        case "NO_TOKEN":
        case "INVALID_TOKEN":
        case "INVALID_TOKEN_FORMAT":
        case "INVALID_TOKEN_PAYLOAD":
          localStorage.removeItem("authToken");
          localStorage.removeItem("user");
          toast.error("–°–µ—Å—Å–∏—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
          window.location.href = "/login";
          break;

        case "TOKEN_EXPIRED":
          localStorage.removeItem("authToken");
          localStorage.removeItem("user");
          toast.error("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
          window.location.href = "/login";
          break;

        default:
          toast.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏");
      }
    } else if (response?.status === 403) {
      const errorCode = response.data?.code;

      switch (errorCode) {
        case "INSUFFICIENT_PERMISSIONS":
          toast.error("–£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏");
          break;

        case "NOT_RESOURCE_OWNER":
          toast.error("–í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ä–µ—Å—É—Ä—Å—ã");
          break;

        default:
          toast.error("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω");
      }
    }

    return Promise.reject(error);
  }
);
```

**TypeScript —Ç–∏–ø—ã –¥–ª—è –æ—à–∏–±–æ–∫:**

```typescript
export type AuthErrorCode =
  | "NO_TOKEN"
  | "INVALID_TOKEN_FORMAT"
  | "TOKEN_EXPIRED"
  | "INVALID_TOKEN"
  | "INVALID_TOKEN_PAYLOAD"
  | "USER_DATA_MISSING"
  | "JWT_SECRET_NOT_CONFIGURED"
  | "AUTH_ERROR";

export type RoleErrorCode =
  | "INVALID_USER_ROLE"
  | "INSUFFICIENT_PERMISSIONS"
  | "NOT_RESOURCE_OWNER"
  | "ROLE_CHECK_ERROR"
  | "RESOURCE_NOT_FOUND"
  | "OWNERSHIP_CHECK_ERROR";

export interface AuthErrorResponse {
  message: string;
  code: AuthErrorCode | RoleErrorCode;
  requiredRoles?: string[];
  userRole?: string;
}
```

---

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

**‚ùå –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**

```typescript
// –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
window.authToken = token;

// –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage –¥–ª—è –æ—á–µ–Ω—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
localStorage.setItem("authToken", token);
```

**‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**

```typescript
// SessionStorage (—Ç–æ–∫–µ–Ω —É–¥–∞–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏)
sessionStorage.setItem("authToken", token);

// HttpOnly Cookie (—Å–∞–º—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–±, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞)
// –¢–æ–∫–µ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è JavaScript, –∑–∞—â–∏—â–µ–Ω –æ—Ç XSS –∞—Ç–∞–∫
```

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞

```typescript
import { jwtDecode } from "jwt-decode";

interface TokenPayload {
  id: string;
  role: string;
  exp: number;
}

const isTokenExpired = (token: string): boolean => {
  try {
    const decoded = jwtDecode<TokenPayload>(token);
    const currentTime = Date.now() / 1000;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å—Ç–µ—á–µ—Ç –ª–∏ —Ç–æ–∫–µ–Ω –≤ –±–ª–∏–∂–∞–π—à–∏–µ 5 –º–∏–Ω—É—Ç
    return decoded.exp < currentTime + 300;
  } catch {
    return true;
  }
};

const checkAndRefreshToken = async () => {
  const token = localStorage.getItem("authToken");

  if (!token || isTokenExpired(token)) {
    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
    window.location.href = "/login";
  }
};

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
setInterval(checkAndRefreshToken, 5 * 60 * 1000);
```

### 3. –ó–∞—â–∏—Ç–∞ —Ä–æ—É—Ç–æ–≤ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

**React Router v6:**

```typescript
import { Navigate, Outlet } from "react-router-dom";

interface ProtectedRouteProps {
  allowedRoles: string[];
}

const ProtectedRoute: React.FC<ProtectedRouteProps> = ({ allowedRoles }) => {
  const token = localStorage.getItem("authToken");
  const userStr = localStorage.getItem("user");

  if (!token) {
    return <Navigate to="/login" replace />;
  }

  if (userStr) {
    const user = JSON.parse(userStr);
    const hasAccess = allowedRoles.includes(user.role);

    if (!hasAccess) {
      return <Navigate to="/forbidden" replace />;
    }
  }

  return <Outlet />;
};

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ä–æ—É—Ç–∞—Ö
<Route element={<ProtectedRoute allowedRoles={["ADMIN", "PRIME"]} />}>
  <Route path="/admin" element={<AdminPanel />} />
</Route>;
```

### 4. –£—Å–ª–æ–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–µ–π

```typescript
import { useAuth } from "./hooks/useAuth";

const Dashboard: React.FC = () => {
  const { user } = useAuth();

  const canDelete = user?.role === "ADMIN" || user?.role === "PRIME";
  const canEdit = canDelete || user?.role === "USER";

  return (
    <div>
      <h1>Dashboard</h1>

      {canEdit && <button>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>}
      {canDelete && <button>–£–¥–∞–ª–∏—Ç—å</button>}

      {user?.role === "PRIME" && (
        <div className="admin-panel">
          <h2>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
        </div>
      )}
    </div>
  );
};
```

### 5. Custom Hook –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```typescript
import { useState, useEffect } from "react";
import { jwtDecode } from "jwt-decode";

interface User {
  _id: string;
  username: string;
  fullname: string;
  role: string;
  telegram?: string;
  photo?: string;
}

interface TokenPayload {
  id: string;
  role: string;
  exp: number;
}

export const useAuth = () => {
  const [user, setUser] = useState<User | null>(null);
  const [token, setToken] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const storedToken = localStorage.getItem("authToken");
    const storedUser = localStorage.getItem("user");

    if (storedToken && storedUser) {
      try {
        const decoded = jwtDecode<TokenPayload>(storedToken);
        const currentTime = Date.now() / 1000;

        if (decoded.exp > currentTime) {
          setToken(storedToken);
          setUser(JSON.parse(storedUser));
        } else {
          logout();
        }
      } catch (error) {
        logout();
      }
    }

    setIsLoading(false);
  }, []);

  const login = (newToken: string, newUser: User) => {
    localStorage.setItem("authToken", newToken);
    localStorage.setItem("user", JSON.stringify(newUser));
    setToken(newToken);
    setUser(newUser);
  };

  const logout = () => {
    localStorage.removeItem("authToken");
    localStorage.removeItem("user");
    setToken(null);
    setUser(null);
  };

  const hasRole = (requiredRole: string): boolean => {
    if (!user) return false;

    const roleHierarchy: Record<string, number> = {
      PRIME: 3,
      ADMIN: 2,
      USER: 1,
    };

    return (
      (roleHierarchy[user.role] || 0) >= (roleHierarchy[requiredRole] || 0)
    );
  };

  return {
    user,
    token,
    isLoading,
    isAuthenticated: !!token,
    login,
    logout,
    hasRole,
  };
};
```

### 6. –¢–∏–ø–∏–∑–∞—Ü–∏—è –¥–ª—è TypeScript

```typescript
// types/auth.ts
export enum RoleType {
  PRIME = "PRIME",
  ADMIN = "ADMIN",
  USER = "USER",
}

export interface User {
  _id: string;
  username: string;
  fullname: string;
  role: RoleType;
  telegram?: string;
  photo?: string;
  createdAt: string;
  updatedAt: string;
}

export interface LoginRequest {
  username: string;
  password: string;
}

export interface LoginResponse {
  user: User;
  token: string;
}

export interface RegisterRequest {
  username: string;
  password: string;
  fullname: string;
  role?: RoleType;
  telegram?: string;
  photo?: string;
}

export interface RegisterResponse {
  user: Omit<User, "password">;
}
```

---

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `Bearer <token>`)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—à–∏–±–∫–µ

---

## Changelog

- **v1.0.0** (2025-01-15) - –ü–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–æ–≤
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π (PRIME, ADMIN, USER)
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ä–µ—Å—É—Ä—Å–∞
  - –ó–∞—â–∏—Ç–∞ –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ API

---

**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 14 –æ–∫—Ç—è–±—Ä—è 2025 –≥.
