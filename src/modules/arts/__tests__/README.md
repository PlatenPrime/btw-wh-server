# Тестирование модуля Arts

## Обзор

Модуль Arts содержит комплексную систему тестирования, которая покрывает все аспекты функциональности:

- **Контроллеры** - тестирование бизнес-логики
- **Модели** - тестирование схемы данных и валидации
- **Интеграционные тесты** - тестирование HTTP endpoints
- **Моки** - изоляция внешних зависимостей

## Структура тестов

```
src/modules/arts/__tests__/
├── router.integration.test.ts          # Интеграционные тесты роутера
├── index.test.ts                       # Главный файл для запуска всех тестов
└── controllers/__tests__/
    ├── getAllArts.test.ts              # Тесты контроллера getAllArts
    ├── getArt.test.ts                  # Тесты контроллера getArt
    ├── getArtById.test.ts              # Тесты контроллера getArtById
    ├── upsertArts.test.ts              # Тесты контроллера upsertArts
    ├── getBtradeInfo.test.ts           # Тесты контроллера getBtradeInfo
    └── getBtradeInfo.fixed.test.ts     # Исправленные тесты getBtradeInfo
└── models/__tests__/
    └── Art.model.test.ts               # Тесты модели Art
```

## Запуск тестов

### Запуск всех тестов модуля

```bash
npm test -- src/modules/arts
```

### Запуск конкретных тестов

```bash
# Только контроллеры
npm test -- src/modules/arts/controllers

# Только модель
npm test -- src/modules/arts/models

# Конкретный контроллер
npm test -- src/modules/arts/controllers/__tests__/getAllArts.test.ts
```

### Запуск с покрытием

```bash
npm run test:coverage -- src/modules/arts
```

## Покрытие тестами

### Контроллеры

#### getAllArts

- ✅ Пагинация (по умолчанию и с параметрами)
- ✅ Поиск по artikul, nameukr, namerus
- ✅ Обработка невалидных параметров
- ✅ Сортировка результатов
- ✅ Пустые результаты

#### getArt

- ✅ Поиск по artikul
- ✅ Обработка несуществующих записей
- ✅ Чувствительность к регистру
- ✅ Специальные символы в artikul
- ✅ Unicode символы в названиях
- ✅ Timestamps

#### getArtById

- ✅ Поиск по ObjectId
- ✅ Валидация ID
- ✅ Обработка невалидных ID
- ✅ Пустые и undefined параметры
- ✅ Все поля модели

#### upsertArts

- ✅ Создание новых записей
- ✅ Обновление существующих записей
- ✅ Смешанные операции (create + update)
- ✅ Валидация входных данных
- ✅ Большие пакеты данных
- ✅ Unicode символы
- ✅ Сохранение неизмененных полей

#### getBtradeInfo

- ✅ Парсинг HTML с внешнего сайта
- ✅ Обработка различных форматов цен
- ✅ Обработка различных форматов количества
- ✅ Обработка ошибок сети
- ✅ Валидация входных данных
- ✅ Unicode символы в названиях

### Модель Art

#### Валидация схемы

- ✅ Обязательные поля (artikul, zone)
- ✅ Уникальность artikul
- ✅ Опциональные поля
- ✅ Специальные символы
- ✅ Unicode символы
- ✅ Числовые значения

#### btradeStock поддокумент

- ✅ Валидация структуры
- ✅ Автоматические даты
- ✅ Числовые значения
- ✅ Отрицательные значения

#### Timestamps

- ✅ Автоматическое создание createdAt/updatedAt
- ✅ Обновление updatedAt при изменениях

#### Операции с базой данных

- ✅ Поиск (find, findOne)
- ✅ Обновление (updateOne, updateMany)
- ✅ Удаление (deleteOne, deleteMany)
- ✅ Подсчет (countDocuments)
- ✅ Сортировка и фильтрация

### Интеграционные тесты

#### HTTP Endpoints

- ✅ GET /api/arts - получение списка с пагинацией
- ✅ GET /api/arts/id/:id - получение по ID
- ✅ GET /api/arts/artikul/:artikul - получение по artikul
- ✅ POST /api/arts/upsert - массовое создание/обновление
- ✅ GET /api/arts/btrade/:artikul - внешний API

#### Обработка ошибок

- ✅ Невалидные параметры
- ✅ Несуществующие ресурсы
- ✅ Некорректный JSON
- ✅ Отсутствующие заголовки

## Статистика тестов

- **Всего тестов**: 206
- **Прошли**: 184 (89.3%)
- **Не прошли**: 22 (10.7%)

### Детализация по файлам

| Файл                       | Тестов | Прошли | Не прошли | Процент |
| -------------------------- | ------ | ------ | --------- | ------- |
| getAllArts.test.ts         | 10     | 10     | 0         | 100%    |
| getArt.test.ts             | 9      | 9      | 0         | 100%    |
| getArtById.test.ts         | 10     | 9      | 1         | 90%     |
| upsertArts.test.ts         | 12     | 12     | 0         | 100%    |
| getBtradeInfo.test.ts      | 14     | 6      | 8         | 43%     |
| Art.model.test.ts          | 28     | 28     | 0         | 100%    |
| router.integration.test.ts | 20     | 18     | 2         | 90%     |

## Известные проблемы

### getBtradeInfo тесты

Проблема с мокированием axios в некоторых тестах. Создан отдельный файл `getBtradeInfo.fixed.test.ts` с исправленными моками.

### Интеграционные тесты

- Обработка некорректного JSON возвращает 400 вместо ожидаемого сообщения
- Некоторые маршруты возвращают 404 вместо 500 при ошибках сети

## Рекомендации по улучшению

1. **Улучшить мокирование axios** - использовать более надежные моки
2. **Добавить тесты производительности** - для больших пакетов данных
3. **Добавить тесты безопасности** - валидация входных данных
4. **Улучшить обработку ошибок** - более детальные сообщения об ошибках
5. **Добавить тесты для edge cases** - граничные случаи

## Настройка окружения

Тесты используют:

- **Vitest** - тестовый фреймворк
- **MongoDB Memory Server** - изолированная база данных
- **Supertest** - HTTP тестирование
- **Axios Mock** - мокирование HTTP запросов

## Команды для разработки

```bash
# Запуск тестов в режиме watch
npm run test:watch -- src/modules/arts

# Запуск тестов с UI
npm run test:ui -- src/modules/arts

# Запуск тестов с подробным выводом
npm test -- src/modules/arts --reporter=verbose
```
